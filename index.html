<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <title>Reklamgiganten m² Kalkylator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="theme-color" content="#ffffff" />
  <style>
    :root{
      --gap:16px; --radius:14px; --shadow:0 6px 18px rgba(0,0,0,.06);
      --safe-b: env(safe-area-inset-bottom, 0px);
      --bar-h: 56px; --drawer-w: 320px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f7f7f8;color:#111;}
    img,canvas,svg,video{max-width:100%;height:auto;display:block}

    /* Topbar */
    .topbar{
      position:sticky; top:0; left:0; right:0; height:var(--bar-h);
      display:flex; align-items:center; gap:10px; padding:0 12px;
      background:#fff; border-bottom:1px solid #eee; z-index:20;
    }
    .iconbtn{
      width:40px; height:40px; border:none; border-radius:10px; background:#f1f2f4; cursor:pointer;
      display:grid; place-items:center; font-size:20px;
    }
    .title{font-weight:800; font-size:16px;}

    /* Layout */
    .wrap{min-height:calc(100% - var(--bar-h)); display:flex; align-items:center; justify-content:center; padding:clamp(12px,2vw,24px);}
    .card{width:100%; max-width:820px; background:#fff; border-radius:var(--radius); box-shadow:var(--shadow); padding:clamp(16px,3vw,28px);}
    h1{margin:0 0 6px; font-size:clamp(18px,3.8vw,26px); line-height:1.2;}
    h2{margin:16px 0 8px; font-size:clamp(16px,3.6vw,20px);}
    .sub{color:#666;margin-bottom:16px;font-size:clamp(12px,2.8vw,14px)}

    .grid{display:grid; gap:var(--gap); grid-template-columns:1fr 1fr;}
    .grid-1{grid-template-columns:1fr;}
    label{display:block; font-weight:600; margin-bottom:6px;}
    input[type="number"], input[type="text"], select{
      width:100%; appearance:none; font-size:clamp(16px,3.8vw,18px);
      padding:14px; border:1px solid #e5e7eb; border-radius:12px; background:#fff;
    }
    input[type="checkbox"]{transform:scale(1.15)}
    .row{display:flex; align-items:center; justify-content:space-between; gap:12px;}
    .unit{color:#444; font-weight:600;}
    .hint{color:#777; font-size:13px;}

    .out{margin-top:16px; background:#0b6; color:#fff; border-radius:12px; padding:16px;}
    .out .kv{display:flex; justify-content:space-between; margin:6px 0;}
    .out .kv b{font-variant-numeric:tabular-nums}
    .actions{display:flex; gap:10px; margin-top:16px;}
    .btn{flex:1; text-align:center; padding:16px; font-weight:700; border-radius:12px; border:none; cursor:pointer; font-size:clamp(16px,4vw,18px)}
    .btn-primary{background:#111; color:#fff;}
    .btn-ghost{background:#f1f2f4; color:#111;}
    .btn-small{padding:10px 12px; border:none; border-radius:10px; cursor:pointer; background:#111; color:#fff; font-weight:700}
    .foot{margin-top:16px; color:#7a7a7a; font-size:12px; text-align:center; padding-bottom:calc(8px + var(--safe-b));}

    /* Drawer (vänsterspalt) */
    .drawer-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.25); opacity:0; pointer-events:none; transition:.2s opacity; z-index:40;}
    .drawer{position:fixed; top:0; left:0; height:100%; width:var(--drawer-w); max-width:92vw; background:#fff; box-shadow: 2px 0 18px rgba(0,0,0,.12);
      transform:translateX(-100%); transition:.25s transform; z-index:41; display:flex; flex-direction:column;}
    .drawer.open{transform:translateX(0)}
    .drawer-backdrop.open{opacity:1; pointer-events:auto;}
    .drawer .hd{padding:14px 14px 8px; border-bottom:1px solid #eee;}
    .drawer .hd b{font-size:16px}
    .drawer .bd{padding:14px; overflow:auto}
    .drawer .grp{margin-bottom:14px}
    .drawer .row2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .preset-list{border:1px solid #eee; border-radius:10px; overflow:hidden}
    .preset-item{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px; border-bottom:1px solid #eee}
    .preset-item:last-child{border-bottom:none}
    .preset-item button{border:none; background:#f1f2f4; padding:8px 10px; border-radius:9px; cursor:pointer}
    .muted{color:#666; font-size:12px}

    /* Badge */
    .badge{display:inline-block; background:#eef7ff; color:#0b6; border:1px solid #d6eefc; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:600}

    /* Stycksaker (tabell/list) */
    .items{border:1px solid #eee; border-radius:12px; overflow:hidden;}
    .items-head, .items-row{
      display:grid; grid-template-columns: 1.2fr 0.7fr 0.7fr 0.9fr 0.6fr;
      gap:0; align-items:center;
    }
    .items-head{background:#fafafa; font-weight:700;}
    .items-cell{padding:10px 12px; border-bottom:1px solid #eee; font-size:14px;}
    .items-row:last-child .items-cell{border-bottom:none}
    .items-actions button{border:none; background:#f1f2f4; padding:8px 10px; border-radius:9px; cursor:pointer; margin-left:6px;}
    @media (max-width:640px){
      .items-head, .items-row{grid-template-columns: 1.6fr 0.8fr 0.8fr 1fr 0.6fr;}
    }
  </style>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar">
    <button class="iconbtn" id="openDrawer" aria-label="Öppna meny">☰</button>
    <div class="title">Reklamgiganten m² Kalkylator</div>
  </div>

  <!-- Drawer -->
  <div class="drawer-backdrop" id="drawerBackdrop"></div>
  <aside class="drawer" id="drawer" aria-label="Förinställningar">
    <div class="hd"><b>Förinställningar</b><div class="muted">Välj eller spara egna</div></div>
    <div class="bd">
      <div class="grp">
        <label for="presetTitle">Förinställd text (titel)</label>
        <input id="presetTitle" type="text" placeholder="t.ex. Fönsterfrost – butik" />
      </div>
      <div class="grp row2">
        <div>
          <label for="presetPrice">Pris/m² (kr)</label>
          <input id="presetPrice" type="number" min="0" step="1" placeholder="t.ex. 699" />
        </div>
        <div>
          <label for="presetMinArea">Min debitering</label>
          <select id="presetMinArea">
            <option value="0">Ingen</option>
            <option value="0.10">0.10 m²</option>
            <option value="0.20">0.20 m²</option>
            <option value="0.30" selected>0.30 m²</option>
            <option value="0.50">0.50 m²</option>
          </select>
        </div>
      </div>
      <div class="grp">
        <label class="row" style="gap:10px;">
          <input id="presetInclVat" type="checkbox" checked />
          Visa pris inkl. moms (25%)
        </label>
      </div>
      <div class="grp row2">
        <button class="btn-small" id="applyPresetBtn">Använd nu</button>
        <button class="btn-small" id="savePresetBtn" style="background:#0b6">Spara som preset</button>
      </div>

      <div class="grp">
        <div class="muted" style="margin:8px 0 6px">Sparade presets</div>
        <div class="preset-list" id="presetList"></div>
      </div>
    </div>
  </aside>

  <!-- Kalkylator -->
  <div class="wrap">
    <div class="card" id="app">
      <h1>m²-kalkylator</h1>
      <div class="sub">Bredd × höjd + valfria <b>stycksaker</b>. <span id="activeBadge" class="badge" style="display:none"></span></div>

      <div class="grid">
        <div>
          <label for="width">Bredd</label>
          <div class="row">
            <input id="width" type="number" inputmode="decimal" placeholder="t.ex. 120" min="1" step="0.1" />
            <span class="unit">cm</span>
          </div>
        </div>
        <div>
          <label for="height">Höjd</label>
          <div class="row">
            <input id="height" type="number" inputmode="decimal" placeholder="t.ex. 80" min="1" step="0.1" />
            <span class="unit">cm</span>
          </div>
        </div>
      </div>

      <div class="grid" style="margin-top:var(--gap);">
        <div>
          <label for="material">Material / typ</label>
          <select id="material">
            <option value="Frost|699">Frost 699 kr/m²</option>
            <option value="Print|699">Print 699 kr/m²</option>
            <option value="Printlaminat|799">Printlaminat 799 kr/m²</option>
            <option value="Vinyl|699">Vinyl 699 kr/m²</option>
            <option value="Vinyl flerfärg|799">Vinyl flerfärg 799 kr/m²</option>
            <option value="Solfilm|899">Solfilm 899 kr/m²</option>
            <option value="__custom__|0" id="customOpt" hidden>⚙️ Anpassat pris</option>
          </select>
          <div class="hint">Preset sätter “Anpassat pris” automatiskt.</div>
        </div>
        <div>
          <label for="minArea">Min debitering</label>
          <select id="minArea">
            <option value="0.10">0.10 m²</option>
            <option value="0.20">0.20 m²</option>
            <option value="0.30" selected>0.30 m² (rekommenderas)</option>
            <option value="0.50">0.50 m²</option>
            <option value="0">Ingen</option>
          </select>
          <div class="hint">Kan också sättas via preset-menyn.</div>
        </div>
      </div>

      <div class="grid grid-1" style="margin-top:var(--gap);">
        <div class="row">
          <label class="row" style="gap:10px;">
            <input id="inclVat" type="checkbox" checked />
            Visa pris inkl. moms (25%)
          </label>
          <span class="hint" id="baseHint"></span>
        </div>
      </div>

      <!-- Stycksaker -->
      <h2>Stycksaker (tillägg)</h2>
      <div class="grid">
        <div>
          <label for="itemName">Benämning</label>
          <input id="itemName" type="text" placeholder="t.ex. Skrapa, Monteringskit, Extra laminat" />
        </div>
        <div>
          <label for="itemPrice">Pris/st (kr)</label>
          <input id="itemPrice" type="number" min="0" step="1" placeholder="t.ex. 49" />
        </div>
        <div>
          <label for="itemQty">Antal</label>
          <input id="itemQty" type="number" min="1" step="1" value="1" />
        </div>
        <div style="display:flex; align-items:flex-end;">
          <button class="btn" id="addItemBtn">Lägg till</button>
        </div>
      </div>

      <div class="items" id="itemsBox" style="margin-top:12px;">
        <div class="items-head">
          <div class="items-cell">Benämning</div>
          <div class="items-cell">Pris/st</div>
          <div class="items-cell">Antal</div>
          <div class="items-cell">Summa</div>
          <div class="items-cell">Åtgärd</div>
        </div>
        <div id="itemsList"></div>
      </div>
      <div class="hint" id="itemsHint" style="margin-top:6px">Du kan spara listan – den ligger kvar i denna enhet.</div>

      <!-- Uträkning -->
      <div class="out" id="out">
        <div class="kv"><span>Area (m²):</span> <b id="area">0</b></div>
        <div class="kv"><span>Debiterad m²:</span> <b id="billArea">0</b></div>
        <div class="kv"><span>Pris/m²:</span> <b id="pricePer">0 kr</b></div>
        <div class="kv"><span>Stycksaker:</span> <b id="itemsTotal">0 kr</b></div>
        <div class="kv"><span>Delsumma:</span> <b id="subtotal">0 kr</b></div>
        <div class="kv"><span>Moms 25%:</span> <b id="vat">0 kr</b></div>
        <hr style="border:none;border-top:1px solid #e9e9e9; margin:10px 0;">
        <div class="kv" style="font-size:1.15em;"><span><b>Att betala</b></span> <b id="total">0 kr</b></div>
      </div>

      <div class="actions">
        <button class="btn btn-ghost" id="resetBtn">Rensa</button>
        <button class="btn btn-primary" id="copyBtn">Kopiera sammanfattning</button>
      </div>

      <div class="foot">app skapad av Reklamgiganten AB</div>
    </div>
  </div>

  <script>
    const $ = id => document.getElementById(id);

    /* ======= Drawer ======= */
    const drawer = $('drawer'), drawerBackdrop = $('drawerBackdrop'), openDrawerBtn = $('openDrawer');
    const openDrawer = ()=>{ drawer.classList.add('open'); drawerBackdrop.classList.add('open'); };
    const closeDrawer = ()=>{ drawer.classList.remove('open'); drawerBackdrop.classList.remove('open'); };
    openDrawerBtn.addEventListener('click', openDrawer);
    drawerBackdrop.addEventListener('click', closeDrawer);

    /* ======= Inputs ======= */
    const width = $('width'), height = $('height'), material = $('material'), minArea = $('minArea'), inclVat = $('inclVat');
    const areaEl = $('area'), billAreaEl = $('billArea'), pricePerEl = $('pricePer'), subtotalEl = $('subtotal'),
          vatEl = $('vat'), totalEl = $('total'), baseHint = $('baseHint'), itemsTotalEl = $('itemsTotal');
    const resetBtn = $('resetBtn'), copyBtn = $('copyBtn'), customOpt = $('customOpt'), activeBadge = $('activeBadge');

    /* ======= Preset UI ======= */
    const presetTitle = $('presetTitle'), presetPrice = $('presetPrice'), presetMinArea = $('presetMinArea'), presetInclVat = $('presetInclVat');
    const applyPresetBtn = $('applyPresetBtn'), savePresetBtn = $('savePresetBtn'), presetList = $('presetList');

    /* ======= Items UI ======= */
    const itemName = $('itemName'), itemPrice = $('itemPrice'), itemQty = $('itemQty'), addItemBtn = $('addItemBtn'), itemsList = $('itemsList');

    const VAT = 0.25;
    const toNum = v => Number(String(v).replace(',', '.')) || 0;
    const round = (n,p=2) => Math.round(n * 10**p)/10**p;
    const fmtSEK = n => new Intl.NumberFormat('sv-SE',{style:'currency',currency:'SEK',maximumFractionDigits:0}).format(n);
    const parseMaterial = val => { const [name, priceStr] = String(val).split('|'); return { name, price: Number(priceStr||0) }; };

    /* ======= Presets ======= */
    const LS_PRESETS = 'rg_presets_v1';
    function getPresets(){ try{return JSON.parse(localStorage.getItem(LS_PRESETS)||'[]')}catch{return[]} }
    function setPresets(list){ localStorage.setItem(LS_PRESETS, JSON.stringify(list)); renderPresetList(); }
    function renderPresetList(){
      const list = getPresets();
      if(!list.length){ presetList.innerHTML = '<div class="preset-item"><span class="muted">Inga sparade ännu</span></div>'; return; }
      presetList.innerHTML = '';
      list.forEach((p,idx)=>{
        const row = document.createElement('div');
        row.className = 'preset-item';
        const left = document.createElement('div');
        left.innerHTML = `<div><b>${p.title||'Anpassat'}</b></div><div class="muted">${(p.price||0)} kr/m² · min ${p.minArea||0} m² · ${p.inclVat?'inkl. moms':'exkl. moms'}</div>`;
        const right = document.createElement('div');
        const useBtn = document.createElement('button'); useBtn.textContent='Använd'; useBtn.onclick=()=>{ loadPresetToDrawer(p); applyCurrentDrawerPreset(); };
        const delBtn = document.createElement('button'); delBtn.textContent='Ta bort'; delBtn.onclick=()=>{ const L=getPresets(); L.splice(idx,1); setPresets(L); };
        right.appendChild(useBtn); right.appendChild(delBtn);
        row.appendChild(left); row.appendChild(right);
        presetList.appendChild(row);
      });
    }
    function loadPresetToDrawer(p){
      presetTitle.value = p.title || '';
      presetPrice.value = p.price || 0;
      presetMinArea.value = String((typeof p.minArea==='number'?p.minArea:p.minArea||0));
      presetInclVat.checked = !!p.inclVat;
    }
    function readDrawerPreset(){
      return {
        title: presetTitle.value.trim() || 'Anpassat',
        price: Math.max(0, Math.round(toNum(presetPrice.value))),
        minArea: toNum(presetMinArea.value),
        inclVat: !!presetInclVat.checked
      };
    }

    let override = null; // {title, price, minArea, inclVat}
    function applyOverrideToUI(){
      if(!override) return;
      activeBadge.style.display = 'inline-block';
      activeBadge.textContent = override.title || 'Anpassat';
      customOpt.hidden = false;
      customOpt.value = `__custom__|${override.price||0}`;
      customOpt.textContent = `⚙️ ${override.title || 'Anpassat'} ${override.price||0} kr/m²`;
      material.value = customOpt.value;
      if(typeof override.minArea !== 'undefined'){ minArea.value = String(override.minArea); }
      inclVat.checked = !!override.inclVat;
    }
    function applyCurrentDrawerPreset(){ override = readDrawerPreset(); applyOverrideToUI(); calc(); closeDrawer(); }

    applyPresetBtn.addEventListener('click', applyCurrentDrawerPreset);
    savePresetBtn.addEventListener('click', ()=>{
      const p = readDrawerPreset();
      const list = getPresets(); list.unshift(p); setPresets(list);
      applyCurrentDrawerPreset();
    });

    (function seedPresetsOnce(){
      if(localStorage.getItem(LS_PRESETS)) return;
      const defaults = [
        { title:'Frost butik', price:699, minArea:0.30, inclVat:true },
        { title:'Printlaminat', price:799, minArea:0.30, inclVat:true },
        { title:'Solfilm Pro', price:899, minArea:0.30, inclVat:true }
      ];
      setPresets(defaults);
    })();
    renderPresetList();

    /* ======= Items (stycksaker) ======= */
    const LS_ITEMS = 'rg_items_v1';
    function getItems(){ try{return JSON.parse(localStorage.getItem(LS_ITEMS)||'[]')}catch{return[]} }
    function setItems(list){ localStorage.setItem(LS_ITEMS, JSON.stringify(list)); renderItems(); calc(); }

    function addItem(name, price, qty){
      const n = (name||'').trim(); const p = Math.max(0, Math.round(toNum(price))); const q = Math.max(1, Math.round(toNum(qty||1)));
      if(!n) return alert('Ange benämning.');
      setItems([...getItems(), {name:n, price:p, qty:q}]);
      itemName.value=''; itemPrice.value=''; itemQty.value='1';
    }
    function updateItem(idx, field, value){
      const list = getItems(); if(!list[idx]) return;
      if(field==='name'){ list[idx].name = String(value).trim(); }
      if(field==='price'){ list[idx].price = Math.max(0, Math.round(toNum(value))); }
      if(field==='qty'){ list[idx].qty = Math.max(1, Math.round(toNum(value))); }
      setItems(list);
    }
    function removeItem(idx){
      const list = getItems(); list.splice(idx,1); setItems(list);
    }
    function itemsTotal(){
      return getItems().reduce((sum, it)=> sum + (Number(it.price||0) * Number(it.qty||0)), 0);
    }
    function renderItems(){
      const list = getItems();
      itemsList.innerHTML = '';
      if(!list.length){
        const row = document.createElement('div');
        row.className='items-row';
        row.innerHTML = `
          <div class="items-cell muted">Inga stycksaker tillagda</div>
          <div class="items-cell"></div><div class="items-cell"></div><div class="items-cell"></div><div class="items-cell"></div>`;
        itemsList.appendChild(row);
        itemsTotalEl.textContent = fmtSEK(0);
        return;
      }
      list.forEach((it, idx)=>{
        const row = document.createElement('div'); row.className='items-row';
        const sum = (Number(it.price||0) * Number(it.qty||0));
        row.innerHTML = `
          <div class="items-cell"><input type="text" value="${it.name}" oninput="updateItem(${idx}, 'name', this.value)" /></div>
          <div class="items-cell"><input type="number" min="0" step="1" value="${it.price}" oninput="updateItem(${idx}, 'price', this.value)" /></div>
          <div class="items-cell"><input type="number" min="1" step="1" value="${it.qty}" oninput="updateItem(${idx}, 'qty', this.value)" /></div>
          <div class="items-cell"><b>${fmtSEK(sum)}</b></div>
          <div class="items-cell items-actions">
            <button onclick="removeItem(${idx})">Ta bort</button>
          </div>`;
        itemsList.appendChild(row);
      });
      itemsTotalEl.textContent = fmtSEK(itemsTotal());
    }
    // gör uppdateringsfunktioner globala för inline-oninput
    window.updateItem = updateItem;
    window.removeItem = removeItem;

    addItemBtn.addEventListener('click', ()=> addItem(itemName.value, itemPrice.value, itemQty.value));

    /* ======= Kalkyl ======= */
    function calc(){
      const w = Math.max(0, toNum(width.value));
      const h = Math.max(0, toNum(height.value));
      let { name, price } = parseMaterial(material.value);

      if(override){ price = override.price || price; name = override.title || name; }
      const minM2 = Math.max(0, toNum(minArea.value));
      const m2 = (w/100) * (h/100);
      const billable = Math.max(m2, minM2);

      const itemsSum = itemsTotal();
      const areaSum = billable * price;
      const subtotal = areaSum + itemsSum;
      const moms = inclVat.checked ? subtotal * VAT : 0;
      const total = subtotal + moms;

      $('area').textContent = round(m2,3).toFixed(3).replace('.', ',');
      $('billArea').textContent = round(billable,3).toFixed(3).replace('.', ',');
      pricePerEl.textContent = fmtSEK(price);
      $('subtotal').textContent = fmtSEK(subtotal);
      $('vat').textContent = inclVat.checked ? fmtSEK(moms) : '–';
      $('total').textContent = fmtSEK(total);
      baseHint.textContent = name;
      itemsTotalEl.textContent = fmtSEK(itemsSum);
    }

    [width,height,material,minArea,inclVat].forEach(el=>{
      el.addEventListener('input', calc);
      el.addEventListener('change', calc);
    });

    resetBtn.addEventListener('click', ()=>{
      width.value = ''; height.value = '';
      material.selectedIndex = 0;
      minArea.value = '0.30'; inclVat.checked = true;
      override = null; activeBadge.style.display = 'none';
      localStorage.removeItem(LS_ITEMS); renderItems();
      calc();
    });

    copyBtn.addEventListener('click', ()=>{
      const { name, price } = parseMaterial(material.value);
      const items = getItems();
      const lines = [
        `Förinställd: ${override ? (override.title||'Anpassat') : name}`,
        `Pris/m²: ${override ? (override.price||price) : price} kr`,
        `Bredd: ${width.value||0} cm`,
        `Höjd: ${height.value||0} cm`,
        `Area: ${$('area').textContent} m²`,
        `Debiterad: ${$('billArea').textContent} m²`,
        `Stycksaker: ${items.length ? '' : '–'}`
      ];
      items.forEach(it=> lines.push(` - ${it.name}: ${it.qty} × ${it.price} kr = ${it.qty*it.price} kr`));
      lines.push(
        `Delsumma: ${$('subtotal').textContent}`,
        `Moms inkluderad: ${inclVat.checked ? 'Ja' : 'Nej'}`,
        `Totalt: ${$('total').textContent}`
      );
      const txt = lines.join('\n');
      if(navigator.clipboard?.writeText){ navigator.clipboard.writeText(txt).then(()=>alert('Kopierat!')); }
      else { const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); alert('Kopierat!'); }
    });

    // Init
    renderItems();
    calc();

    // WebView back fallback
    if (window.history && history.pushState){
      history.pushState(null, '', location.href);
      window.addEventListener('popstate', function(){});
    }
  </script>
</body>
</html>
