<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Offert på språng</title>

  <!-- Viktigt för GitHub Pages/TWA -->
  <base href="/Priskalkylator/">

  <!-- Manifest & tema -->
  <link rel="manifest" href="/Priskalkylator/manifest.webmanifest">
  <meta name="theme-color" content="#0f1115" />
  <meta name="description" content="Offert på språng – en smidig priskalkylator för dekaler, print, vinyl och solfilm.">
  <!-- Blockera indexering i sökmotorer -->
  <meta name="robots" content="noindex, nofollow" />

  <!-- Ikoner (absoluta vägar) -->
  <link rel="icon" type="image/png" sizes="192x192" href="/Priskalkylator/Icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/Priskalkylator/Icon-512.png">
  <link rel="apple-touch-icon" href="/Priskalkylator/Apple-touch-icon.png">

  <!-- iOS helskärm -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <style>
    :root{
      --bg:#0f1115; --card:#1f2937; --line:#2a2f3c; --focus:#3b82f6;
      --text:#ffffff; --muted:#b7c0cf; --btn:#16a34a; --btn-hover:#139043; --row:#0b0d12;
      --danger:#b91c1c;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:-apple-system,system-ui,Helvetica,Arial,sans-serif;
      display:flex; justify-content:center; align-items:flex-start; padding:28px 16px;
    }
    .wrap{
      position:relative; width:100%; max-width:920px; background:var(--card);
      border-radius:22px; box-shadow:0 14px 40px rgba(0,0,0,.35); padding:22px 18px 20px;
    }
    .logo{ display:block; margin:50px auto 12px; width:220px; max-width:65%; border-radius:12px }
    h1{ margin:8px 0 6px; text-align:center; font-size:30px }
    h2{ margin:16px 0 8px; font-size:18px; color:var(--muted) }
    label{ display:block; font-size:12px; color:var(--muted); margin:10px 0 6px }
    input,select{
      width:100%; border-radius:14px; border:1px solid var(--line);
      padding:12px; font-size:16px; background:#fff; color:#000; outline:none;
    }
    input:focus,select:focus{ border-color:var(--focus); box-shadow:0 0 0 3px rgba(59,130,246,.25) }

    .grid2{ display:grid; gap:12px }
    .grid3{ display:grid; gap:12px }
    @media (min-width:720px){
      .grid2{ grid-template-columns:1fr 1fr }
      .grid3{ grid-template-columns:1fr 1fr 1fr }
    }

    .row{
      background:var(--row); border:1px solid var(--line); border-radius:16px; padding:12px; margin-top:12px;
    }

    /* Tabeller */
    .compact-list{ margin-top:10px; border:1px solid var(--line); border-radius:14px; overflow:hidden }
    .compact-list table{ width:100%; border-collapse:collapse; font-size:14px }
    .compact-list th,.compact-list td{ padding:10px 10px; border-bottom:1px solid #2a2f3c; white-space:nowrap }
    .compact-list th{ text-align:left; color:var(--muted); font-weight:600 }
    .compact-list tr:last-child td{ border-bottom:none }
    .compact-list td:nth-child(2), .compact-list td:nth-child(3){ text-align:right }
    .compact-list .act{ text-align:right }
    .compact-list tr:hover td{ background:#121722 }
    .compact-list th:last-child,.compact-list td:last-child{
      position:sticky; right:0; background:var(--row); box-shadow:-6px 0 10px rgba(0,0,0,.12); z-index:1;
    }

    .remove{ background:var(--danger); color:#fff; border:none; border-radius:10px; padding:8px 12px; cursor:pointer; font-size:14px; line-height:1 }
    .remove:hover{ filter:brightness(1.06) }

    .out{ margin-top:16px; border-radius:14px; padding:14px 12px; background:var(--row); border:1px dashed var(--line); min-height:24px }
    .hint{ color:var(--muted); font-size:12px; margin-top:6px }
    .btn{ margin-top:12px; width:100%; border:none; border-radius:14px; padding:14px 16px; font-size:16px; color:#fff; cursor:pointer; background:var(--btn) }
    .btn:hover{ background:var(--btn-hover) }
    .btn.secondary{ background:#0b0d12; border:1px solid var(--line); color:#fff }

    /* Drawer */
    .hamburger{
      position:absolute; left:14px; top:14px; width:42px; height:42px; border-radius:12px;
      border:1px solid var(--line); background:#11151d; color:#fff; cursor:pointer;
      display:grid; place-items:center; font-size:20px; z-index:1000;
    }
    .drawer-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.45); opacity:0; pointer-events:none; transition:.2s opacity; z-index:9998 }
    .drawer{ position:fixed; top:0; left:0; height:100%; width:360px; max-width:92vw; background:#0f1115; border-right:1px solid #1e2430; box-shadow:8px 0 40px rgba(0,0,0,.35); transform:translateX(-100%); transition:.25s transform; z-index:9999; color:#e5e7eb; display:flex; flex-direction:column }
    .drawer.open{ transform:translateX(0) }
    .drawer-backdrop.open{ opacity:1; pointer-events:auto }
    .drawer .hd{ padding:14px; border-bottom:1px solid #1e2430; font-size:16px; font-weight:700 }
    .drawer .bd{ padding:14px; overflow:auto }
    .drawer .grp{ margin-bottom:14px }
    .drawer .row2{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
    .drawer .btn-mini{ padding:10px 12px; border:none; border-radius:10px; cursor:pointer; background:var(--btn); color:#fff; font-weight:700 }
    .preset-list{ border:1px solid #1e2430; border-radius:12px; overflow:hidden }
    .preset-item{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px; border-bottom:1px solid #1e2430 }
    .preset-item:last-child{ border-bottom:none }
    .preset-item button{ border:none; background:#11151d; color:#fff; padding:8px 10px; border-radius:9px; cursor:pointer }
    .drawer .muted{ color:#9aa3b2; font-size:12px }

    #versionLabel{ margin-top:12px; margin-bottom:10px; text-align:center; font-size:13px; color:#b7c0cf }
    .logoPreview{ width:100%; max-width:260px; display:block; margin:6px 0 8px; border-radius:12px; background:#11151d; padding:8px }
  </style>
</head>
<body>
  <div class="wrap">
    <button class="hamburger" id="openDrawer" aria-label="Öppna meny" type="button">☰</button>

    <!-- Fast logga i appen -->
    <img class="logo" id="companyLogo" src="/Priskalkylator/Icon-512.png" alt="Logotyp" />

    <h1>Offert på språng</h1>

    <!-- Avsändare + Moms -->
    <div class="grid2">
      <div>
        <label for="avsandare">Företag (avsändare)</label>
        <input id="avsandare" type="text" placeholder="Ditt företagsnamn" />
      </div>
      <div>
        <label for="moms">Välj moms</label>
        <select id="moms">
          <option value="0">Exkl. moms</option>
          <option value="0.25" selected>Inkl. 25%</option>
        </select>
      </div>
    </div>

    <!-- Kunduppgifter -->
    <div class="grid2">
      <div>
        <label for="kundnamn">Kundnamn</label>
        <input id="kundnamn" type="text" />
      </div>
      <div>
        <label for="telefon">Telefon</label>
        <input id="telefon" type="tel" />
      </div>
    </div>

    <!-- Mått -->
    <div class="row">
      <h2>Lägg till mått</h2>

      <div class="grid2">
        <div>
          <label for="artikel">Artikel/Benämning (styr pris via presets)</label>
          <input id="artikel" type="text" list="artikelOptions" placeholder="t.ex. vinylmatta" />
          <datalist id="artikelOptions"></datalist>
        </div>
        <div>
          <label for="pris">Pris per m² (kr)</label>
          <input id="pris" type="number" value="699" min="0" step="1" />
        </div>
      </div>

      <div class="grid3">
        <div>
          <label for="hojd">Höjd (mm)</label>
          <input id="hojd" type="number" min="1" />
        </div>
        <div>
          <label for="bredd">Bredd (mm)</label>
          <input id="bredd" type="number" min="1" />
        </div>
        <div>
          <label for="antal">Antal (st)</label>
          <input id="antal" type="number" value="1" min="1" step="1" />
        </div>
      </div>

      <!-- LIVE m²: exkl + inkl moms -->
      <div id="measurePreview" class="hint">Skriv mått så visas radens pris här…</div>

      <!-- ÄNDRAD TEXT -->
      <button class="btn" id="addMeasure" type="button">Beräkna & lägg till mått</button>
      <div class="hint">Tips: skriv namnet på en sparad preset i <b>Artikel</b> så fylls pris och moms automatiskt.</div>
    </div>

    <!-- Måttlista -->
    <div class="compact-list" id="listWrap" style="display:none">
      <table>
        <thead>
          <tr>
            <th>Benämning</th>
            <th>Antal</th>
            <th>Summa</th>
            <th class="act">Åtgärd</th>
          </tr>
        </thead>
        <tbody id="measuresBody"></tbody>
      </table>
    </div>

    <!-- Stycksaker + Tid -->
    <div class="row">
      <h2>Stycksaker</h2>
      <div class="grid3">
        <div><label for="itemName">Benämning</label><input id="itemName" type="text" list="itemOptions" placeholder="t.ex. Skruvar" /></div>
        <div><label for="itemPrice">Pris/st (kr)</label><input id="itemPrice" type="number" min="0" step="1" /></div>
        <div><label for="itemQty">Antal</label><input id="itemQty" type="number" min="1" step="1" value="1" /></div>
      </div>

      <!-- LIVE stycksak: exkl + inkl moms -->
      <div id="itemPreview" class="hint"></div>

      <!-- ÄNDRAD TEXT -->
      <button class="btn" id="addItemBtn" type="button">Beräkna & lägg till stycksak</button>

      <div class="grid3" style="margin-top:12px">
        <div><label for="hourRate">Timpeng (kr/h)</label><input id="hourRate" type="number" min="0" step="1" placeholder="t.ex. 650" /></div>
        <div><label for="hoursQty">Antal timmar</label><input id="hoursQty" type="number" min="0" step="0.25" placeholder="t.ex. 1.5" /></div>
        <div style="display:grid;align-items:end">
          <!-- ÄNDRAD TEXT -->
          <button class="btn" id="addTimeBtn" type="button">Beräkna & lägg till timpeng</button>
        </div>
      </div>

      <!-- LIVE tid: exkl + inkl moms -->
      <div id="timePreview" class="hint"></div>

      <div class="compact-list" id="itemsBox" style="margin-top:12px; display:none">
        <table>
          <thead><tr><th>Benämning</th><th>Antal</th><th>Summa</th><th class="act">Åtgärd</th></tr></thead>
          <tbody id="itemsList"></tbody>
        </table>
      </div>
      <datalist id="itemOptions"></datalist>
    </div>

    <!-- Resultat -->
    <label style="margin-top:14px">Beräknat pris (alla mått , stycksaker,timpeng)</label>
    <div id="result" class="out">Lägg till ett mått.</div>
    <div id="details" class="hint"></div>

    <button class="btn" id="share" type="button">Dela priset</button>
    <button class="btn secondary" id="pdf" type="button">Skapa offert (PDF)</button>
    <div id="versionLabel">V.Benjii</div>
  </div>

  <!-- Drawer -->
  <div class="drawer-backdrop" id="drawerBackdrop" aria-hidden="true"></div>
  <aside class="drawer" id="drawer" aria-label="Förinställningar" aria-hidden="true">
    <div class="hd">Förinställningar</div>
    <div class="bd">
      <div class="grp">
        <div class="row2">
          <a class="btn-mini" href="/Priskalkylator/">Kalkylatorn</a>
        </div>
      </div>

      <div class="grp">
        <div style="margin-bottom:8px"><b>PDF-logga (visas endast i PDF)</b></div>
        <input id="logoFile" type="file" accept="image/*" />
        <img id="logoPreview" class="logoPreview" alt="Förhandsvisning" style="display:none" />
        <div class="row2" style="margin-top:8px">
          <button class="btn-mini" id="logoClear" type="button">Ta bort logga</button>
          <span class="muted" style="display:grid;align-items:center">Sparas lokalt (denna enhet)</span>
        </div>
      </div>

      <div class="grp">
        <div style="margin-bottom:8px"><b>Välj eller spara egna</b></div>
        <label>Förinställd text (titel)</label>
        <input id="presetTitle" type="text" placeholder="t.ex. Frost, Print, Vinyl" />
        <div class="row2" style="margin-top:8px">
          <div><label>Pris/m² (kr)</label><input id="presetPrice" type="number" min="0" step="1" /></div>
        </div>
        <label style="margin-top:8px"><input id="presetVat" type="checkbox" checked /> Inkludera 25% moms</label>
        <div class="row2" style="margin-top:10px">
          <button class="btn-mini" id="presetUseNow" type="button">Använd nu</button>
          <button class="btn-mini" id="presetSave" type="button">Spara preset</button>
        </div>
        <div class="muted" style="margin-top:8px">Sparas i din webbläsare (localStorage).</div>
      </div>

      <div class="grp">
        <div style="margin-bottom:8px"><b>Sparade m²-presets</b></div>
        <div class="preset-list" id="presetList"></div>
      </div>
    </div>
  </aside>

  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    "use strict";

    const $ = id => document.getElementById(id);
    const LS_PRESETS = "rg_presets_v1";
    const LS_ITEMS   = "rg_items_v1";        /* <-- FIX: tog bort "the" */
    const LS_TPLS    = "rg_item_templates_v1";
    const LS_LOGO    = "rg_company_logo_dataurl"; // PDF-logga

    const measures = [];
    let items = loadJSON(LS_ITEMS, []);
    let presets = loadJSON(LS_PRESETS, []);
    let itemTemplates = loadJSON(LS_TPLS, []);
    let logoDataURL = localStorage.getItem(LS_LOGO) || "";

    function loadJSON(key, fallback){
      try{ return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
      catch{ return fallback; }
    }
    function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

    function setLogoPreview(){
      const el = $("logoPreview");
      if(logoDataURL){ el.src = logoDataURL; el.style.display="block"; }
      else{ el.style.display="none"; }
    }

    // Helpers (format)
    const fmt0 = n => Number(n||0).toLocaleString("sv-SE",{maximumFractionDigits:0});
    const fmt2 = n => Number(n||0).toLocaleString("sv-SE",{minimumFractionDigits:2,maximumFractionDigits:2});

    // Live-preview MÅTT (inkl moms)
    function previewMeasureLine(){
      const h = parseFloat($("hojd").value);
      const b = parseFloat($("bredd").value);
      const qty = parseFloat($("antal").value || "1");
      const price = parseFloat($("pris").value);
      const moms = parseFloat($("moms").value || "0");
      const box = $("measurePreview");

      if(!h || !b || !price || !qty){
        box.textContent = "Skriv mått så visas radens pris här…";
        return;
      }
      const area = (h/1000)*(b/1000);
      const exkl = area * price * qty;
      const inkl = exkl * (1+moms);

      box.textContent =
        `Rad: ${fmt2(area)} m²/st × ${price} kr/m² × ${qty} st = ${fmt0(exkl)} kr exkl • ${fmt0(inkl)} kr inkl moms`;
    }

    // Live-preview STYCKSAK
    function previewItemLine(){
      const price = parseFloat($("itemPrice").value);
      const qty   = parseFloat($("itemQty").value || "1");
      const moms  = parseFloat($("moms").value || "0");
      const box   = $("itemPreview");
      if(!price || !qty){ box.textContent = ""; return; }
      const exkl = price * qty;
      const inkl = exkl * (1+moms);
      box.textContent = `Rad: ${fmt0(exkl)} kr exkl • ${fmt0(inkl)} kr inkl moms`;
    }

    // Live-preview TID
    function previewTimeLine(){
      const rate  = parseFloat($("hourRate").value);
      const hours = parseFloat($("hoursQty").value);
      const moms  = parseFloat($("moms").value || "0");
      const box   = $("timePreview");
      if(!rate || !hours){ box.textContent = ""; return; }
      const exkl = rate * hours;
      const inkl = exkl * (1+moms);
      box.textContent = `Rad: ${fmt0(exkl)} kr exkl • ${fmt0(inkl)} kr inkl moms`;
    }

    function render(){
      // Måttlista
      const body = $("measuresBody"); body.innerHTML = ""; let total = 0;
      measures.forEach((m,i)=>{
        total += m.exkl;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td style="white-space:normal"><b>${m.artikel || "-"}</b><br>${m.h}×${m.b} mm</td>
          <td>${m.qty}</td>
          <td>${fmt0(m.exkl)} kr</td>
          <td class="act"><button class="remove" data-i="${i}" aria-label="Ta bort rad">×</button></td>`;
        body.appendChild(tr);
      });
      $("listWrap").style.display = measures.length ? "block" : "none";

      // Stycksaker/tid
      const itemsList = $("itemsList"); itemsList.innerHTML = ""; let totalItems = 0;
      items.forEach((it,i)=>{
        totalItems += it.price*it.qty;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td style="white-space:normal">${it.name}</td>
          <td>${it.qty}</td>
          <td>${fmt0(it.price*it.qty)} kr</td>
          <td class="act"><button class="remove" data-item="${i}" aria-label="Ta bort stycksak">×</button></td>`;
        itemsList.appendChild(tr);
      });
      $("itemsBox").style.display = items.length ? "block" : "none";
      $("itemsHint").style.display = items.length ? "none" : "block";

      // Summering (inkl moms)
      const moms = parseFloat($("moms").value || "0");
      const sumExkl = total + totalItems;
      const sumMoms = sumExkl * moms;
      const sumInkl = sumExkl + sumMoms;
      $("result").textContent  = `${fmt0(sumInkl)} kr`;
      $("details").textContent = `${fmt0(sumExkl)} kr • Moms: ${fmt0(sumMoms)} kr`;

      saveJSON(LS_ITEMS, items);
    }

    // Datalist för artikel
    function refreshArtikelDatalist(){
      const dl = $("artikelOptions"); dl.innerHTML = "";
      presets.forEach(p=>{
        const opt = document.createElement("option"); opt.value = p.artikel; dl.appendChild(opt);
      });
    }
    $("artikel").addEventListener("change", ()=>{
      const name = $("artikel").value.trim();
      const p = presets.find(x => x.artikel.toLowerCase() === name.toLowerCase());
      if(p){ $("pris").value = p.pris; $("moms").value = p.moms; previewMeasureLine(); }
    });

    // Reagera på momsbyte – uppdatera previews + totals
    $("moms").addEventListener("change", ()=>{ previewMeasureLine(); previewItemLine(); previewTimeLine(); render(); });

    // Lägg till mått
    $("addMeasure").addEventListener("click", ()=>{
      const artikel = $("artikel").value.trim();
      const h = parseFloat($("hojd").value);
      const b = parseFloat($("bredd").value);
      const qty = parseInt($("antal").value);
      const price = parseFloat($("pris").value);
      if(!h||!b||!qty||!price) return;
      const area = (h/1000)*(b/1000);
      const exkl = area*price*qty;
      measures.push({ artikel, h, b, qty, area, price, exkl });
      render();
      previewMeasureLine();
    });

    // Ta bort rader
    document.addEventListener("click", (e)=>{
      const t = e.target;
      if(!(t instanceof HTMLElement)) return;
      const i = t.getAttribute("data-i");
      const itemIdx = t.getAttribute("data-item");
      if(i!=null){ measures.splice(Number(i),1); render(); }
      if(itemIdx!=null){ items.splice(Number(itemIdx),1); render(); }
    });

    // Stycksaker
    $("addItemBtn").addEventListener("click", ()=>{
      const name = $("itemName").value.trim();
      const price = parseFloat($("itemPrice").value);
      const qty = parseInt($("itemQty").value);
      if(!name||!price||!qty) return;
      items.push({ name, price, qty });
      $("itemName").value = ""; $("itemPrice").value = ""; $("itemQty").value = "1";
      render(); previewItemLine();
    });

    // Tid
    $("addTimeBtn").addEventListener("click", ()=>{
      const rate = parseFloat($("hourRate").value);
      const hours = parseFloat($("hoursQty").value);
      if(!rate || !hours) return;
      items.push({ name:"Arbetstid", price: rate, qty: hours });
      $("hourRate").value=""; $("hoursQty").value="";
      render(); previewTimeLine();
    });

    // Input-listeners för live-priser
    ["hojd","bredd","antal","pris","artikel"].forEach(id=>{
      $(id).addEventListener("input", previewMeasureLine);
      $(id).addEventListener("change", previewMeasureLine);
    });
    ["itemPrice","itemQty"].forEach(id=>{
      $(id).addEventListener("input", previewItemLine);
      $(id).addEventListener("change", previewItemLine);
    });
    ["hourRate","hoursQty"].forEach(id=>{
      $(id).addEventListener("input", previewTimeLine);
      $(id).addEventListener("change", previewTimeLine);
    });

    // Dela
    $("share").addEventListener("click", ()=>{
      const text = `${$("result").textContent} (${$("details").textContent})`;
      if(navigator.share){
        navigator.share({ title:"Offert", text }).catch(()=>{});
      } else {
        navigator.clipboard?.writeText(text).then(()=>alert("Belopp kopierat!")).catch(()=>alert(text));
      }
    });

    // PDF
    $("pdf").addEventListener("click", ()=>{
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:"mm", format:"a4" });

      const left=15,right=15,top=18,bottom=18;
      const pageW=doc.internal.pageSize.getWidth(), pageH=doc.internal.pageSize.getHeight();
      let y=top;

      const addY = mm => y+=mm;
      const today    = new Date().toLocaleDateString("sv-SE");
      const company  = ($("avsandare").value || "Företag").trim();
      const customer = ($("kundnamn").value || "").trim();
      const phone    = ($("telefon").value || "").trim();
      const momsSats = parseFloat(($("moms")||{value:"0"}).value || "0");

      if(logoDataURL){
        try{
          const p = doc.getImageProperties(logoDataURL);
          const maxW = 60, maxH = 22;
          let w = maxW, h = maxW * (p.height/p.width);
          if(h>maxH){ h = maxH; w = h * (p.width/p.height); }
          const x = (pageW - w) / 2;
          doc.addImage(logoDataURL, p.fileType || "PNG", x, y-6, w, h);
          addY(20);
        }catch(e){}
      }

      doc.setFont("helvetica","bold"); doc.setFontSize(18); doc.text("Offert", left, y);
      doc.setFont("helvetica","normal"); doc.setFontSize(11);
      const rightX = pageW-right; doc.text(today, rightX, y, { align:"right" });
      addY(8);

      doc.setFontSize(9); doc.setTextColor(90); doc.text("Offert från", left, y);
      doc.setTextColor(0); doc.setFont("helvetica","bold"); doc.setFontSize(12); doc.text(company, left, y+5);

      doc.setFontSize(9); doc.setTextColor(90); doc.text("Kunduppgifter", rightX, y, {align:"right"});
      doc.setTextColor(0); doc.setFont("helvetica","normal"); doc.setFontSize(10);
      doc.text(`Kundnamn: ${customer || "-"}`, rightX, y+6,  {align:"right"});
      doc.text(`Telefon: ${phone || "-"}`,    rightX, y+12, {align:"right"});

      y += 18;

      const col1W=120, col2W=pageW-left-right-col1W, col1X=left, col2X=left+col1W;
      const fmt0p = n => Number(n||0).toLocaleString("sv-SE",{maximumFractionDigits:0});
      const fmt2p = n => Number(n||0).toLocaleString("sv-SE",{minimumFractionDigits:2,maximumFractionDigits:2});
      doc.setFont("helvetica","bold"); doc.setFontSize(11);
      doc.text("Benämning", col1X, y); doc.text("Belopp", col2X+col2W, y, {align:"right"}); addY(6);
      doc.setDrawColor(200); doc.line(left, y, pageW-right, y); addY(6); doc.setFont("helvetica","normal");

      measures.forEach(l=>{
        const radText = [
          `${l.artikel || "Artikel"}`,
          `${l.h} × ${l.b} mm • ${fmt2p((l.h/1000)*(l.b/1000))} m²/st • á ${fmt2p(l.price)} kr/m²`
        ].join("\n");
        const wrapped = doc.splitTextToSize(radText, col1W);
        const rowH = Math.max(8, wrapped.length*5);
        if (y+rowH > pageH-bottom-14) { doc.addPage(); y=top; }
        doc.setFontSize(10); doc.text(wrapped, col1X, y);
        doc.setFont("helvetica","bold"); doc.text(`${fmt0p(l.exkl)} kr`, col2X+col2W, y, {align:"right"});
        doc.setFont("helvetica","normal"); y += rowH+4; doc.setDrawColor(235); doc.line(left, y, pageW-right, y); y += 4;
      });

      const savedItems = JSON.parse(localStorage.getItem(LS_ITEMS) || "[]");
      if(savedItems.length){
        if (y+10 > pageH-bottom) { doc.addPage(); y=top; }
        doc.setFont("helvetica","bold"); doc.text("Stycksaker & tid", col1X, y); y += 8; doc.setFont("helvetica","normal");
        savedItems.forEach(it=>{
          if (y+8 > pageH-bottom) { doc.addPage(); y=top; }
          doc.text(`${it.qty} × ${it.name}`, col1X, y);
          doc.setFont("helvetica","bold"); doc.text(`${fmt0p(it.price*it.qty)} kr`, col2X+col2W, y, {align:"right"});
          doc.setFont("helvetica","normal"); y += 6;
        });
        y += 2; doc.setDrawColor(235); doc.line(left, y, pageW-right, y); y += 4;
      }

      const sumExklMeasures = measures.reduce((s,l)=> s + l.exkl, 0);
      const sumExklItems = (savedItems||[]).reduce((s,it)=> s + (Number(it.price||0)*Number(it.qty||0)), 0);
      const sumExkl = sumExklMeasures + sumExklItems;
      const momsBelopp = sumExkl * momsSats;
      const sumInkl = sumExkl + momsBelopp;

      [["Summa exkl. moms", fmt0p(sumExkl) + " kr", true],
       [`${Math.round(momsSats*100)}%`, fmt0p(momsBelopp) + " kr", false],
       ["Att betala", `${fmt0p(sumInkl)} kr ${momsSats>0?"(inkl. moms)":"(exkl. moms)"}`, true]
      ].forEach(([label,value,bold])=>{
        if (y+12 > pageH-bottom) { doc.addPage(); y=top; }
        doc.setFontSize(11); doc.setFont("helvetica", bold?"bold":"normal");
        doc.text(label, col1X, y); doc.text(value, col2X+col2W, y, {align:"right"});
        y += 7; doc.setDrawColor(220); doc.line(left, y, pageW-right, y); y += 5;
      });

      const safeName = (($("kundnamn").value || "offert").replace(/[^\w\- åäöÅÄÖ]/g,"_"));
      doc.save(`${safeName}.pdf`);
    });

    // Drawer
    (function(){
      const btn = $("openDrawer"), drawer = $("drawer"), backdrop = $("drawerBackdrop");
      function open(){ drawer.classList.add("open"); backdrop.classList.add("open");
        drawer.setAttribute("aria-hidden","false"); backdrop.setAttribute("aria-hidden","false");
        document.body.style.overflow="hidden"; }
      function close(){ drawer.classList.remove("open"); backdrop.classList.remove("open");
        drawer.setAttribute("aria-hidden","true"); backdrop.setAttribute("aria-hidden","true");
        document.body.style.overflow=""; }
      btn.addEventListener("click", e=>{ e.stopPropagation(); open(); });
      backdrop.addEventListener("click", close);
      document.addEventListener("keydown", e=>{ if(e.key==="Escape") close(); });

      if(logoDataURL){ setLogoPreview(); }
      $("logoFile").addEventListener("change", (e)=>{
        const file = e.target.files?.[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          logoDataURL = reader.result;
          localStorage.setItem(LS_LOGO, logoDataURL);
          setLogoPreview();
          alert("PDF-logga sparad! (påverkar ej loggan i appen)");
        };
        reader.readAsDataURL(file);
      });
      $("logoClear").addEventListener("click", ()=>{
        localStorage.removeItem(LS_LOGO);
        logoDataURL=""; setLogoPreview();
      });

      function renderPresetList(){
        const list = $("presetList"); list.innerHTML = "";
        presets.forEach((p,idx)=>{
          const row = document.createElement("div");
          row.className = "preset-item";
          row.innerHTML = `
            <span>${p.artikel} — ${p.pris} kr/m² ${p.moms===0.25?"(inkl 25%)":"(exkl)"}</span>
            <span>
              <button data-use="${idx}">Använd</button>
              <button data-del="${idx}">Ta bort</button>
            </span>`;
          list.appendChild(row);
        });
        list.onclick = e=>{
          const t = e.target;
          if(!(t instanceof HTMLElement)) return;
          const use = t.getAttribute("data-use");
          const del = t.getAttribute("data-del");
          if(use!=null){
            const p = presets[Number(use)];
            $("artikel").value = p.artikel; $("pris").value = p.pris; $("moms").value = p.moms;
            previewMeasureLine(); close();
          } else if(del!=null){
            presets.splice(Number(del),1);
            localStorage.setItem(LS_PRESETS, JSON.stringify(presets));
            renderPresetList();
          }
        };
      }
      renderPresetList();

      $("presetUseNow").addEventListener("click", ()=>{
        const artikel = $("presetTitle").value.trim();
        const pris    = parseFloat($("presetPrice").value);
        const moms    = $("presetVat").checked ? 0.25 : 0;
        if(!artikel || !pris) return;
        $("artikel").value = artikel; $("pris").value = pris; $("moms").value = moms;
        previewMeasureLine();
      });

      $("presetSave").addEventListener("click", ()=>{
        const artikel = $("presetTitle").value.trim();
        const pris    = parseFloat($("presetPrice").value);
        const moms    = $("presetVat").checked ? 0.25 : 0;
        if(!artikel || !pris) return;
        const existing = presets.find(p=>p.artikel.toLowerCase()===artikel.toLowerCase());
        if(existing){ existing.pris=pris; existing.moms=moms; }
        else{ presets.push({artikel, pris, moms}); }
        localStorage.setItem(LS_PRESETS, JSON.stringify(presets));
        renderPresetList();
        $("presetTitle").value=""; $("presetPrice").value="";
      });
    })();

    // Init
    function initPreviews(){ previewMeasureLine(); previewItemLine(); previewTimeLine(); }
    render(); refreshArtikelDatalist(); initPreviews();
  </script>

  <!-- Åtkomst-gate för TWA -->
  <style>
    #appGate{
      position:fixed; inset:0; display:none; place-items:center;
      background:rgba(0,0,0,.98); z-index:99999;
      color:#fff; text-align:center; padding:24px;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }
    #appGate .box{
      max-width:560px; width:min(92vw,560px);
      background:#11151d; border:1px solid #2a2f3c; border-radius:16px; padding:22px;
      box-shadow:0 12px 30px rgba(0,0,0,.35)
    }
    #appGate h3{ margin:0 0 8px; font-size:20px }
    #appGate p{ margin:6px 0 0; color:#b7c0cf; font-size:14px }
  </style>
  <div id="appGate" aria-live="assertive" aria-hidden="true">
    <div class="box">
      <h3>Åtkomst nekad</h3>
      <p>Den här tjänsten kan bara användas i <b>Offert på språng</b>-appen.</p>
    </div>
  </div>
  <script>
  (function () {
    var isFromTWA = document.referrer &&
                    document.referrer.indexOf('android-app://se.reklamgiganten.priskalkylator') === 0;

    if (isFromTWA) {
      try { sessionStorage.setItem('twa_ok', '1'); } catch(e) {}
    }
    var allowed = isFromTWA || (function(){
      try { return sessionStorage.getItem('twa_ok') === '1'; } catch(e) { return false; }
    })();

    if (!allowed) {
      var app = document.querySelector('.wrap');
      if (app) app.style.display = 'none';
      var gate = document.getElementById('appGate');
      if (gate) gate.style.display = 'grid';
      document.body.style.overflow = 'hidden';
    }
  })();
  </script>

  <!-- PWA: registrera service worker och rätt scope -->
  <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/Priskalkylator/sw.js', { scope: '/Priskalkylator/' }).then(reg => {
      if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });
      reg.addEventListener('updatefound', () => {
        const sw = reg.installing;
        if (!sw) return;
        sw.addEventListener('statechange', () => {
          if (sw.state === 'installed' && reg.waiting) {
            reg.waiting.postMessage({ type: 'SKIP_WAITING' });
          }
        });
      });
    }).catch(console.error);
  }
  </script>
</body>
</html>
