<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>M2 Priskalkylator</title>

  <style>
    :root{
      --bg:#0f1115; --card:#1f2937; --line:#2a2f3c; --focus:#3b82f6;
      --text:#ffffff; --muted:#b7c0cf; --btn:#16a34a; --btn-hover:#139043; --row:#0b0d12;
      --danger:#9b1c1c;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:-apple-system,system-ui,Helvetica,Arial,sans-serif;
      display:flex; justify-content:center; align-items:flex-start; padding:28px 16px;
    }
    .wrap{
      position:relative;
      width:100%; max-width:920px; background:var(--card);
      border-radius:22px; box-shadow:0 14px 40px rgba(0,0,0,.35); padding:22px 18px 20px;
    }
    .logo{
      display:block; margin:50px auto 12px; width:220px; max-width:65%; border-radius:12px;
    }
    h1{ margin:8px 0 6px; text-align:center; font-size:30px }
    h2{ margin:16px 0 8px; font-size:18px; color:var(--muted) }
    label{ display:block; font-size:12px; color:var(--muted); margin:10px 0 6px }
    input,select{
      width:100%; border-radius:14px; border:1px solid var(--line);
      padding:12px; font-size:16px; background:#fff; color:#000; outline:none;
    }
    input:focus,select:focus{ border-color:var(--focus); box-shadow:0 0 0 3px rgba(59,130,246,.25) }

    .grid2{ display:grid; gap:12px }
    .grid3{ display:grid; gap:12px }
    @media (min-width:720px){
      .grid2{ grid-template-columns:1fr 1fr }
      .grid3{ grid-template-columns:1fr 1fr 1fr }
    }

    .row{
      background:var(--row); border:1px solid var(--line); border-radius:16px; padding:12px; margin-top:12px;
    }
    .compact-list{
      margin-top:10px; border:1px solid var(--line); border-radius:14px; overflow:hidden;
    }
    .compact-list table{ width:100%; border-collapse:collapse; font-size:14px; }
    .compact-list th, .compact-list td{ padding:10px 8px; border-bottom:1px solid #2a2f3c; }
    .compact-list th{ text-align:left; color:var(--muted); font-weight:600; }
    .compact-list tr:last-child td{ border-bottom:none }
    .compact-list .act{ text-align:right }
    .remove{ background:var(--danger); color:#fff; border:none; border-radius:10px; padding:6px 10px; cursor:pointer; }
    .remove:hover{ filter:brightness(1.1) }

    .out{ margin-top:16px; border-radius:14px; padding:14px 12px; background:var(--row); border:1px dashed var(--line); min-height:24px }
    .hint{ color:var(--muted); font-size:12px; margin-top:6px }
    .btn{ margin-top:12px; width:100%; border:none; border-radius:14px; padding:14px 16px; font-size:16px;
      color:#fff; cursor:pointer; background:var(--btn) }
    .btn:hover{ background:var(--btn-hover) }
    .btn.secondary{ background:#0b0d12; border:1px solid var(--line); color:#fff }

    /* Drawer */
    .hamburger{
      position:absolute; left:14px; top:14px; width:42px; height:42px; border-radius:12px;
      border:1px solid var(--line); background:#11151d; color:#fff; cursor:pointer;
      display:grid; place-items:center; font-size:20px; z-index: 1000;
    }
    .drawer-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.45); opacity:0; pointer-events:none; transition:.2s opacity; z-index:9998;
    }
    .drawer{
      position:fixed; top:0; left:0; height:100%; width:360px; max-width:92vw; background:#0f1115;
      border-right:1px solid #1e2430; box-shadow: 8px 0 40px rgba(0,0,0,.35);
      transform:translateX(-100%); transition:.25s transform; z-index:9999; color:#e5e7eb;
      display:flex; flex-direction:column;
    }
    .drawer.open{ transform:translateX(0) }
    .drawer-backdrop.open{ opacity:1; pointer-events:auto }
    .drawer .hd{ padding:14px; border-bottom:1px solid #1e2430; font-size:16px; font-weight:700 }
    .drawer .bd{ padding:14px; overflow:auto }
    .drawer .grp{ margin-bottom:14px }
    .drawer .row2{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
    .drawer .btn-mini{
      padding:10px 12px; border:none; border-radius:10px; cursor:pointer; background:var(--btn); color:#fff; font-weight:700
    }
    .preset-list{ border:1px solid #1e2430; border-radius:12px; overflow:hidden }
    .preset-item{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px; border-bottom:1px solid #1e2430 }
    .preset-item:last-child{ border-bottom:none }
    .preset-item button{ border:none; background:#11151d; color:#fff; padding:8px 10px; border-radius:9px; cursor:pointer }
    .drawer .muted{ color:#9aa3b2; font-size:12px }

    /* Version label */
    #versionLabel{
      margin-top:12px; margin-bottom:10px; text-align:center; font-size:13px; color:#b7c0cf;
    }
    .logoPreview{
      width:100%; max-width:260px; display:block; margin:6px 0 8px; border-radius:12px; background:#11151d; padding:8px
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Menyknapp -->
    <button class="hamburger" id="openDrawer" aria-label="Öppna meny" type="button">☰</button>

    <!-- LOGGA (kan bytas i drawern) -->
    <img class="logo" id="companyLogo" src="/assets/images/IMG_0059-1757208666308.jpeg"
         alt="Logotyp" onerror="this.style.display='none'" />

    <h1>M2 Priskalkylator</h1>

    <!-- Avsändare + Moms -->
    <div class="grid2">
      <div>
        <label for="avsandare">Företag (avsändare)</label>
        <input id="avsandare" type="text" placeholder="Ditt företagsnamn" />
      </div>
      <div>
        <label for="moms">Moms</label>
        <select id="moms">
          <option value="0">Exkl. moms</option>
          <option value="0.25" selected>Inkl. 25%</option>
        </select>
      </div>
    </div>

    <!-- Kunduppgifter -->
    <div class="grid2">
      <div>
        <label for="kundnamn">Kundnamn</label>
        <input id="kundnamn" type="text" />
      </div>
      <div>
        <label for="telefon">Telefon</label>
        <input id="telefon" type="tel" />
      </div>
    </div>

    <!-- === Mått & pris i samma ram (TVÅ RADER) === -->
    <div class="row">
      <h2>Lägg till mått</h2>

      <!-- Rad 1: Artikel, Pris/m², Minimidebitering -->
      <div class="grid3">
        <div>
          <label for="artikel">Artikel/Benämning (styr pris via presets)</label>
          <input id="artikel" type="text" list="artikelOptions" placeholder="t.ex. Frost, Print, Vinyl" />
          <datalist id="artikelOptions"></datalist>
        </div>
        <div>
          <label for="pris">Pris per m² (kr)</label>
          <input id="pris" type="number" value="699" min="0" step="1" />
        </div>
        <div>
          <label for="minpris">Minimidebitering (kr/rad)</label>
          <input id="minpris" type="number" value="0" min="0" step="1" />
        </div>
      </div>

      <!-- Rad 2: Höjd, Bredd, Antal -->
      <div class="grid3">
        <div>
          <label for="hojd">Höjd (mm)</label>
          <input id="hojd" type="number" min="1" />
        </div>
        <div>
          <label for="bredd">Bredd (mm)</label>
          <input id="bredd" type="number" min="1" />
        </div>
        <div>
          <label for="antal">Antal (st)</label>
          <input id="antal" type="number" value="1" min="1" step="1" />
        </div>
      </div>

      <button class="btn" id="addMeasure" type="button">+ Lägg till mått</button>
      <div class="hint">Tips: skriv namnet på en sparad preset i <b>Artikel</b> så fylls pris/min/moms automatiskt.</div>
    </div>

    <!-- Lista över mått -->
    <div class="compact-list" id="listWrap" style="display:none">
      <table>
        <thead>
          <tr>
            <th>Artikel / Mått</th>
            <th>Antal</th>
            <th>Area/st</th>
            <th>Pris/m²</th>
            <th>Exkl (rad)</th>
            <th class="act">Åtgärd</th>
          </tr>
        </thead>
        <tbody id="measuresBody"></tbody>
      </table>
    </div>

    <!-- Stycksaker + Tid -->
    <div class="row">
      <h2>Stycksaker</h2>
      <div class="grid3">
        <div><label for="itemName">Benämning</label><input id="itemName" type="text" list="itemOptions" placeholder="t.ex. Skrapa" /></div>
        <div><label for="itemPrice">Pris/st (kr)</label><input id="itemPrice" type="number" min="0" step="1" /></div>
        <div><label for="itemQty">Antal</label><input id="itemQty" type="number" min="1" step="1" value="1" /></div>
      </div>
      <button class="btn" id="addItemBtn" type="button">+ Lägg till stycksak</button>

      <!-- Tidrad -->
      <div class="grid3" style="margin-top:12px">
        <div><label for="hourRate">Timpeng (kr/h)</label><input id="hourRate" type="number" min="0" step="1" placeholder="t.ex. 650" /></div>
        <div><label for="hoursQty">Antal timmar</label><input id="hoursQty" type="number" min="0" step="0.25" placeholder="t.ex. 1.5" /></div>
        <div style="display:grid;align-items:end"><button class="btn" id="addTimeBtn" type="button">+ Lägg till tid</button></div>
      </div>

      <div class="compact-list" id="itemsBox" style="margin-top:12px; display:none">
        <table>
          <thead><tr><th>Benämning</th><th>Pris/st</th><th>Antal</th><th>Summa</th><th class="act">Åtgärd</th></tr></thead>
          <tbody id="itemsList"></tbody>
        </table>
      </div>
      <div class="hint" id="itemsHint">Stycksaker & tid sparas i denna enhet (localStorage).</div>
      <datalist id="itemOptions"></datalist>
    </div>

    <!-- Resultat -->
    <label style="margin-top:14px">Beräknat pris (alla mått + stycksaker)</label>
    <div id="result" class="out">Lägg till ett mått.</div>
    <div id="details" class="hint"></div>

    <button class="btn" id="share" type="button">Dela priset</button>
    <button class="btn secondary" id="pdf" type="button">Skapa offert (PDF)</button>
    <div id="versionLabel">V.Benjii</div>
  </div>

  <!-- Drawer -->
  <div class="drawer-backdrop" id="drawerBackdrop" aria-hidden="true"></div>
  <aside class="drawer" id="drawer" aria-label="Förinställningar" aria-hidden="true">
    <div class="hd">Förinställningar</div>
    <div class="bd">
      <!-- Snabblänkar -->
      <div class="grp">
        <div class="row2">
          <a class="btn-mini" href="/">Kalkylatorn</a>
        </div>
      </div>

      <!-- Egna loggan -->
      <div class="grp">
        <div style="margin-bottom:8px"><b>Egen logga (visas i app & PDF)</b></div>
        <input id="logoFile" type="file" accept="image/*" />
        <img id="logoPreview" class="logoPreview" alt="Förhandsvisning" style="display:none" />
        <div class="row2" style="margin-top:8px">
          <button class="btn-mini" id="logoClear" type="button">Ta bort logga</button>
          <span class="muted" style="display:grid;align-items:center">Sparas lokalt (denna enhet)</span>
        </div>
      </div>

      <!-- Presets m² -->
      <div class="grp">
        <div style="margin-bottom:8px"><b>Välj eller spara egna</b></div>
        <label>Förinställd text (titel)</label>
        <input id="presetTitle" type="text" placeholder="t.ex. Frost, Print, Vinyl" />
        <div class="row2" style="margin-top:8px">
          <div><label>Pris/m² (kr)</label><input id="presetPrice" type="number" min="0" step="1" /></div>
          <div><label>Minimidebitering (kr/rad)</label><input id="presetMin" type="number" min="0" step="1" /></div>
        </div>
        <label style="margin-top:8px"><input id="presetVat" type="checkbox" checked /> Inkludera 25% moms</label>
        <div class="row2" style="margin-top:10px">
          <button class="btn-mini" id="presetUseNow" type="button">Använd nu</button>
          <button class="btn-mini" id="presetSave" type="button">Spara preset</button>
        </div>
        <div class="muted" style="margin-top:8px">Sparas i din webbläsare (localStorage).</div>
      </div>

      <div class="grp">
        <div style="margin-bottom:8px"><b>Sparade m²-presets</b></div>
        <div class="preset-list" id="presetList"></div>
      </div>

      <!-- Item-templates -->
      <div class="grp">
        <div style="margin-bottom:8px"><b>Stycksaks-mallar</b></div>
        <label>Benämning</label>
        <input id="tplName" type="text" placeholder="t.ex. Skrapa, Monteringskit" />
        <label>Pris/st (kr)</label>
        <input id="tplPrice" type="number" min="0" step="1" placeholder="t.ex. 49" />
        <div class="row2" style="margin-top:10px">
          <button class="btn-mini" id="tplSave" type="button">Spara mall</button>
          <span class="muted" style="display:grid;align-items:center">Sparas utan antal</span>
        </div>
        <div class="preset-list" id="tplList" style="margin-top:10px"></div>
      </div>
    </div>
  </aside>

  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    const $ = id => document.getElementById(id);
    const LS_PRESETS = "rg_presets_v1";
    const LS_ITEMS   = "rg_items_v1";
    const LS_TPLS    = "rg_item_templates_v1";
    const LS_LOGO    = "rg_company_logo_dataurl";

    const measures = [];
    let items = loadJSON(LS_ITEMS, []);            // {name, price, qty}
    let presets = loadJSON(LS_PRESETS, [
      { artikel:"Frost", pris:699, moms:0.25, min:0 },
      { artikel:"Print", pris:699, moms:0.25, min:0 },
      { artikel:"Printlaminat", pris:799, moms:0.25, min:0 },
      { artikel:"Vinyl", pris:699, moms:0.25, min:0 },
      { artikel:"Vinyl flerfärg", pris:799, moms:0.25, min:0 },
      { artikel:"Solfilm", pris:899, moms:0.25, min:0 }
    ]);
    let itemTemplates = loadJSON(LS_TPLS, []);
    let logoDataURL = localStorage.getItem(LS_LOGO) || "";

    function loadJSON(key, fallback){
      try{ return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
      catch{ return fallback; }
    }
    function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

    function setLogoPreview(){
      const el = $("logoPreview");
      if(logoDataURL){
        el.src = logoDataURL; el.style.display="block";
        $("companyLogo").src = logoDataURL; $("companyLogo").style.display="block";
      }else{
        el.style.display="none";
      }
    }

    function render(){
      // Mått
      const body = $("measuresBody"); body.innerHTML = ""; let total = 0;
      measures.forEach((m,i)=>{
        total += m.exkl;
        const tr = document.createElement("tr");
        tr.innerHTML =
          <td><b>$%7Bm.artikel || "-"%7D</b><br>$%7Bm.h%7D×$%7Bm.b%7D mm</td>
          <td>$%7Bm.qty%7D</td>
          <td>$%7Bm.area.toFixed(2)%7D m²</td>
          <td>$%7Bm.price%7D kr</td>
          <td>$%7Bm.exkl.toFixed(0)%7D kr</td>
          <td class="act"><button class="remove" data-i="$%7Bi%7D">X</button></td>;
        body.appendChild(tr);
      });
      $("listWrap").style.display = measures.length ? "block" : "none";

      // Stycksaker + tid
      const itemsList = $("itemsList"); itemsList.innerHTML = ""; let totalItems = 0;
      items.forEach((it,i)=>{
        totalItems += it.price*it.qty;
        const tr = document.createElement("tr");
        tr.innerHTML =
          <td>$%7Bit.name%7D</td>
          <td>$%7Bit.price%7D kr</td>
          <td>$%7Bit.qty%7D</td>
          <td>$%7B(it.price*it.qty).toFixed(0)%7D kr</td>
          <td class="act"><button class="remove" data-item="$%7Bi%7D">X</button></td>;
        itemsList.appendChild(tr);
      });
      $("itemsBox").style.display = items.length ? "block" : "none";
      $("itemsHint").style.display = items.length ? "none" : "block";

      // Summering
      const moms = parseFloat($("moms").value || "0");
      const sumExkl = total + totalItems;
      const sumMoms = sumExkl * moms;
      const sumInkl = sumExkl + sumMoms;
      $("result").textContent =
7BsumInkl.toFixed(0)%7D kr
;
      $("details").textContent =
$%7BsumExkl.toFixed(0)%7D kr • Moms: $%7BsumMoms.toFixed(0)%7D kr
;

      saveJSON(LS_ITEMS, items);
    }

    // Autocomplete: artikel ↔ presets
    function refreshArtikelDatalist(){
      const dl = $("artikelOptions"); dl.innerHTML = "";
      presets.forEach(p=>{
        const opt = document.createElement("option");
        opt.value = p.artikel;
        dl.appendChild(opt);
      });
    }
    $("artikel").addEventListener("change", ()=>{
      const name = $("artikel").value.trim();
      const p = presets.find(x => x.artikel.toLowerCase() === name.toLowerCase());
      if(p){
        $("pris").value = p.pris;
        $("minpris").value = p.min;
        $("moms").value = p.moms;
      }
    });

    // Lägg till mått
    $("addMeasure").addEventListener("click", ()=>{
      const artikel = $("artikel").value.trim();
      const h = parseFloat($("hojd").value);
      const b = parseFloat($("bredd").value);
      const qty = parseInt($("antal").value);
      const price = parseFloat($("pris").value);
      const min = parseFloat($("minpris").value || "0");
      if(!h||!b||!qty||!price) return;
      const area = (h/1000)*(b/1000);
      let exkl = area*price*qty;
      if(min && exkl < min) exkl = min;
      measures.push({ artikel, h, b, qty, area, price, exkl });
      render();
    });
    $("measuresBody").addEventListener("click", (e)=>{
      const i = e.target?.dataset?.i;
      if(i!=null){ measures.splice(Number(i),1); render(); }
    });

    // Stycksaker
    $("addItemBtn").addEventListener("click", ()=>{
      const name = $("itemName").value.trim();
      const price = parseFloat($("itemPrice").value);
      const qty = parseInt($("itemQty").value);
      if(!name||!price||!qty) return;
      items.push({ name, price, qty });
      $("itemName").value = ""; $("itemPrice").value = ""; $("itemQty").value = "1";
      render();
    });
    $("itemsList").addEventListener("click", (e)=>{
      const i = e.target?.dataset?.item;
      if(i!=null){ items.splice(Number(i),1); render(); }
    });

    // Tid
    $("addTimeBtn").addEventListener("click", ()=>{
      const rate = parseFloat($("hourRate").value);
      const hours = parseFloat($("hoursQty").value);
      if(!rate || !hours) return;
      items.push({ name:"Arbetstid", price: rate, qty: hours });
      $("hourRate").value=""; $("hoursQty").value="";
      render();
    });

    // Autocomplete: stycksaks-mallar ⇒ fyll pris
    $("itemName").addEventListener("input", ()=>{
      const name = $("itemName").value.trim().toLowerCase();
      const tpl = itemTemplates.find(t => t.name.toLowerCase() === name);
      if(tpl){ $("itemPrice").value = tpl.price; }
    });

    // Share
    $("share").addEventListener("click", ()=>{
      const text =
$%7B$("result").textContent%7D ($%7B $("details").textContent %7D)
;
      if(navigator.share){
        navigator.share({ title:"Offert", text }).catch(()=>{});
      } else {
        // Fallback: kopiera till klippbord
        navigator.clipboard?.writeText(text).then(()=>alert("Belopp kopierat!")).catch(()=>alert(text));
      }
    });

    // PDF (med logga uppe till höger + giltighetstext)
    $("pdf").addEventListener("click", ()=>{
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:"mm", format:"a4" });

      const left=15,right=15,top=18,bottom=18;
      const pageW=doc.internal.pageSize.getWidth(), pageH=doc.internal.pageSize.getHeight();
      let y=top;

      const fmt2 = n => Number(n).toLocaleString("sv-SE",{minimumFractionDigits:2,maximumFractionDigits:2});
      const fmt0 = n => Number(n).toLocaleString("sv-SE",{maximumFractionDigits:0});
      const addY = mm => y+=mm;

      const today = new Date().toLocaleDateString("sv-SE");
      const company = ($("avsandare").value || "Företag");
      const customer = $("kundnamn").value || "";
      const phone = $("telefon").value || "";
      const artikel = $("artikel").value || "Artikel";
      const momsSats = parseFloat(($("moms")||{value:"0"}).value || "0");

      // Header
      doc.setFont("helvetica","bold"); doc.setFontSize(18); doc.text("Offert", left, y);
      // logga uppe till höger (om finns)
      if(logoDataURL){
        try{
          const imgProps = doc.getImageProperties(logoDataURL);
          const maxW = 40, maxH = 18; // lagom i hörnet
          let w = maxW, h = maxW * (imgProps.height/imgProps.width);
          if(h>maxH){ h = maxH; w = h * (imgProps.width/imgProps.height); }
          doc.addImage(logoDataURL, imgProps.fileType || "PNG", pageW-right-w, y-6, w, h);
        }catch(e){}
      }
      doc.setFontSize(11); doc.setFont("helvetica","normal");
      const rightX = pageW-right; doc.text(
7Btoday%7D
, rightX, y, { align:"right" }); addY(6);
      doc.setTextColor(90); doc.text("Offerten är giltig i 30 dagar", rightX, y, { align:"right" });
      doc.setTextColor(0); addY(10);

      doc.setFontSize(9); doc.setTextColor(90); doc.text("Offert från", left, y);
      doc.setTextColor(0); addY(5); doc.setFont("helvetica","bold"); doc.setFontSize(12); doc.text(company, left, y);
      doc.setFont("helvetica","normal");
      if (customer || phone){ addY(8); doc.setFontSize(10); if(customer) doc.text(
7Bcustomer%7D
, left, y); if(phone) doc.text(
7Bphone%7D
, left+90, y); }
      addY(10);

      // Kolumnrubriker
      const col1W=120, col2W=pageW-left-right-col1W, col1X=left, col2X=left+col1W;
      doc.setFont("helvetica","bold"); doc.setFontSize(11);
      doc.text("Benämning / Mått", col1X, y); doc.text("Belopp", col2X+col2W, y, {align:"right"}); addY(6);
      doc.setDrawColor(200); doc.line(left, y, pageW-right, y); addY(6); doc.setFont("helvetica","normal");

      // Måttrader
      (window.measures||[]).forEach(l=>{
        const radText = [
         
7Bartikel%7D
,
         
7Bl.qty%7D st — $%7Bl.h%7D × $%7Bl.b%7D mm per styck
,
         
$%7Bfmt2(l.area)%7D m², á $%7Bfmt2(l.price)%7D kr/m²$%7Bl.min>0?
• min ${fmt0(l.min)%7D kr:""}
        ].join("\n");
        const wrapped = doc.splitTextToSize(radText, col1W); const rowH = Math.max(8, wrapped.length*5);
        if (y+rowH > pageH-bottom-14) { doc.addPage(); y=top; }
        doc.setFontSize(10); doc.text(wrapped, col1X, y);
        doc.setFont("helvetica","bold"); doc.text(
7Bfmt0(l.exkl)%7D kr
, col2X+col2W, y, {align:"right"});
        doc.setFont("helvetica","normal"); y += rowH+4; doc.setDrawColor(235); doc.line(left, y, pageW-right, y); y += 4;
      });

      // Stycksaker / Tid
      if(items.length){
        if (y+10 > pageH-bottom) { doc.addPage(); y=top; }
        doc.setFont("helvetica","bold"); doc.text("Stycksaker & tid", col1X, y); y += 8; doc.setFont("helvetica","normal");
        items.forEach(it=>{
          if (y+8 > pageH-bottom) { doc.addPage(); y=top; }
          doc.text(
7Bit.qty%7D × $%7Bit.name%7D á $%7Bfmt0(it.price)%7D kr
, col1X, y);
          doc.setFont("helvetica","bold"); doc.text(
7Bfmt0(it.price*it.qty)%7D kr
, col2X+col2W, y, {align:"right"});
          doc.setFont("helvetica","normal"); y += 6;
        });
        y += 2; doc.setDrawColor(235); doc.line(left, y, pageW-right, y); y += 4;
      }

      // Summor
      const sumExklMeasures = (window.measures||[]).reduce((s,l)=>s+l.exkl,0);
      const sumExklItems = items.reduce((s,it)=> s + (Number(it.price||0)*Number(it.qty||0)), 0);
      const sumExkl = sumExklMeasures + sumExklItems;
      const momsBelopp = sumExkl * momsSats;
      const sumInkl = sumExkl + momsBelopp;

      const sumBlock = [
        ["Summa exkl. moms", fmt0(sumExkl) + " kr", true],
        [
$%7BMath.round(momsSats*100)%7D%
, fmt0(momsBelopp) + " kr", false],
        ["Att betala",
7Bfmt0(sumInkl)%7D kr $%7BmomsSats>0?"(inkl. moms)":"(exkl. moms)"%7D
, true]
      ];
      sumBlock.forEach(([label,value,bold])=>{
        if (y+12 > pageH-bottom) { doc.addPage(); y=top; }
        doc.setFontSize(11); doc.setFont("helvetica", bold?"bold":"normal");
        doc.text(label, col1X, y); doc.text(value, col2X+col2W, y, {align:"right"});
        y += 7; doc.setDrawColor(220); doc.line(left, y, pageW-right, y); y += 5;
      });

      // Spara
      const safeName = (($("kundnamn").value || "offert").replace(/[^\w\- åäöÅÄÖ]/g,"_"));
      doc.save(
7BsafeName%7D.pdf
);
    });

    // Drawer
    (function(){
      const btn = $("openDrawer"), drawer = $("drawer"), backdrop = $("drawerBackdrop");
      function open(){ drawer.classList.add("open"); backdrop.classList.add("open");
        drawer.setAttribute("aria-hidden","false"); backdrop.setAttribute("aria-hidden","false");
        document.body.style.overflow="hidden";
      }
      function close(){ drawer.classList.remove("open"); backdrop.classList.remove("open");
        drawer.setAttribute("aria-hidden","true"); backdrop.setAttribute("aria-hidden","true");
        document.body.style.overflow="";
      }
      btn.addEventListener("click", e=>{ e.stopPropagation(); open(); });
      backdrop.addEventListener("click", close);
      document.addEventListener("keydown", e=>{ if(e.key==="Escape") close(); });

      // LOGGA: ladda/preview/spara/ta bort
      if(logoDataURL){
        setLogoPreview();
      }
      $("logoFile").addEventListener("change", (e)=>{
        const file = e.target.files?.[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          logoDataURL = reader.result;
          localStorage.setItem(LS_LOGO, logoDataURL);
          setLogoPreview();
          alert("Logga sparad! Den används även i PDF.");
        };
        reader.readAsDataURL(file);
      });
      $("logoClear").addEventListener("click", ()=>{
        localStorage.removeItem(LS_LOGO);
        logoDataURL=""; setLogoPreview();
        $("companyLogo").style.display="none";
      });

      // Lagring & render av m²-presets
      function renderPresetList(){
        const list = $("presetList"); list.innerHTML = "";
        presets.forEach((p,idx)=>{
          const row = document.createElement("div");
          row.className = "preset-item";
          row.innerHTML =
            <span>$%7Bp.artikel%7D — $%7Bp.pris%7D kr/m²$%7Bp.min?, min ${p.min%7D kr
$%7Bp.moms===0.25?"(inkl 25%)":"(exkl)"%7D</span>
            <span>
              <button data-use="$%7Bidx%7D">Använd</button>
              <button data-del="$%7Bidx%7D">Ta bort</button>
            </span>;
          list.appendChild(row);
        });
        refreshArtikelDatalist();
      }
      renderPresetList();

      $("presetUseNow").addEventListener("click", ()=>{
        const artikel = $("presetTitle").value.trim();
        const pris    = parseFloat($("presetPrice").value);
        const min     = parseFloat($("presetMin").value || "0");
        const moms    = $("presetVat").checked ? 0.25 : 0;
        if(!artikel || !pris) return;
        $("artikel").value = artikel;
        $("pris").value = pris;
        $("minpris").value = min;
        $("moms").value = moms;
      });

      $("presetSave").addEventListener("click", ()=>{
        const artikel = $("presetTitle").value.trim();
        const pris    = parseFloat($("presetPrice").value);
        const min     = parseFloat($("presetMin").value || "0");
        const moms    = $("presetVat").checked ? 0.25 : 0;
        if(!artikel || !pris) return;
        const existing = presets.find(p=>p.artikel.toLowerCase()===artikel.toLowerCase());
        if(existing){ existing.pris=pris; existing.min=min; existing.moms=moms; }
        else{ presets.push({artikel, pris, min, moms}); }
        saveJSON(LS_PRESETS, presets);
        renderPresetList();
        $("presetTitle").value=""; $("presetPrice").value=""; $("presetMin").value="";
      });

      $("presetList").addEventListener("click", (e)=>{
        const use = e.target.getAttribute("data-use");
        const del = e.target.getAttribute("data-del");
        if(use!=null){
          const p = presets[Number(use)];
          $("artikel").value = p.artikel;
          $("pris").value = p.pris;
          $("minpris").value = p.min;
          $("moms").value = p.moms;
          close();
        } else if(del!=null){
          presets.splice(Number(del),1);
          saveJSON(LS_PRESETS, presets);
          renderPresetList();
        }
      });

      // Item-templates
      function renderTpls(){
        const box = $("tplList"); box.innerHTML = "";
        itemTemplates.forEach((t,i)=>{
          const row = document.createElement("div");
          row.className = "preset-item";
          row.innerHTML =
            <span>$%7Bt.name%7D — $%7Bt.price%7D kr/st</span>
            <span>
              <button data-add="$%7Bi%7D">Lägg till</button>
              <button data-del="$%7Bi%7D">Ta bort</button>
            </span>;
          box.appendChild(row);
        });
        const itemDL = $("itemOptions"); itemDL.innerHTML = "";
        itemTemplates.forEach(t=>{
          const opt = document.createElement("option");
          opt.value = t.name;
          itemDL.appendChild(opt);
        });
      }
      renderTpls();

      $("tplSave").addEventListener("click", ()=>{
        const name = $("tplName").value.trim();
        const price = parseFloat($("tplPrice").value);
        if(!name || !price) return;
        const existing = itemTemplates.find(t=>t.name.toLowerCase()===name.toLowerCase());
        if(existing){ existing.price = price; }
        else{ itemTemplates.push({ name, price }); }
        saveJSON(LS_TPLS, itemTemplates);
        renderTpls();
        $("tplName").value=""; $("tplPrice").value="";
      });

      $("tplList").addEventListener("click", (e)=>{
        const add = e.target.getAttribute("data-add");
        const del = e.target.getAttribute("data-del");
        if(add!=null){
          const t = itemTemplates[Number(add)];
          const qty = Number(prompt(
för $%7Bt.name%7D?
, "1")||"0");
          if(qty>0){ items.push({ name:t.name, price:t.price, qty }); render(); }
        }else if(del!=null){
          itemTemplates.splice(Number(del),1);
          saveJSON(LS_TPLS, itemTemplates);
          renderTpls();
        }
      });
    })();

    // Init
    if(logoDataURL){ setLogoPreview(); }
    render();
    refreshArtikelDatalist();
  </script>
</body>
</html>
