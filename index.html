<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Offert p√• spr√•ng</title>

  <base href="/Priskalkylator/">
  <link rel="manifest" href="/Priskalkylator/manifest.webmanifest">
  <meta name="theme-color" content="#0f1115" />
  <meta name="description" content="Offert p√• spr√•ng ‚Äì en smidig priskalkylator f√∂r dekaler, print, vinyl och solfilm.">
  <meta name="robots" content="noindex, nofollow" />
  <link rel="icon" type="image/png" sizes="192x192" href="/Priskalkylator/Icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/Priskalkylator/Icon-512.png">
  <link rel="apple-touch-icon" href="/Priskalkylator/Apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <style>
    :root{
      --bg:#0f1115; --card:#1f2937; --line:#2a2f3c; --focus:#3b82f6;
      --text:#ffffff; --muted:#b7c0cf; --btn:#16a34a; --btn-hover:#139043; --row:#0b0d12;
      --danger:#b91c1c;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:-apple-system,system-ui,Helvetica,Arial,sans-serif;
      display:flex; justify-content:center; align-items:flex-start; padding:28px 16px;
    }
    .wrap{
      position:relative; width:100%; max-width:920px; background:var(--card);
      border-radius:22px; box-shadow:0 14px 40px rgba(0,0,0,.35); padding:22px 18px 20px;
    }

    .logo{ display:block; margin:10px auto 8px; width:220px; max-width:65%; border-radius:12px }
    h1{ margin:6px 0 8px; text-align:center; font-size:30px }
    #openDrawer.btn{ margin-top:6px; margin-bottom:10px }

    h2{ margin:16px 0 8px; font-size:18px; color:var(--muted) }
    label{ display:block; font-size:12px; color:var(--muted); margin:10px 0 6px }
    input,select,textarea{
      width:100%; border-radius:14px; border:1px solid var(--line);
      padding:12px; font-size:16px; background:#fff; color:#000; outline:none;
    }
    textarea{ min-height:90px; resize:vertical }
    input:focus,select:focus,textarea:focus{ border-color:var(--focus); box-shadow:0 0 0 3px rgba(59,130,246,.25) }

    #otherInfo::placeholder, #offerNote::placeholder{
      font-size:13px; line-height:1.4; color:#a6afbf; opacity:1;
    }

    .grid2{ display:grid; gap:12px }
    .grid3{ display:grid; gap:12px }
    @media (min-width:720px){ .grid2{ grid-template-columns:1fr 1fr } .grid3{ grid-template-columns:1fr 1fr 1fr } }

    .row{ background:var(--row); border:1px solid var(--line); border-radius:16px; padding:12px; margin-top:12px }

    .compact-list{ margin-top:10px; border:1px solid var(--line); border-radius:14px; overflow:hidden }
    .compact-list table{ width:100%; border-collapse:collapse; font-size:14px }
    .compact-list th,.compact-list td{ padding:10px 10px; border-bottom:1px solid #2a2f3c; white-space:nowrap }
    .compact-list th{ text-align:left; color:var(--muted); font-weight:600 }
    .compact-list tr:last-child td{ border-bottom:none }
    .compact-list td:nth-child(2), .compact-list td:nth-child(3){ text-align:right }
    .compact-list .act{ text-align:right }
    .compact-list tr:hover td{ background:#121722 }
    .compact-list th:last-child,.compact-list td:last-child{
      position:sticky; right:0; background:var(--row); box-shadow:-6px 0 10px rgba(0,0,0,.12); z-index:1;
    }

    .remove{ background:var(--danger); color:#fff; border:none; border-radius:10px; padding:8px 12px; cursor:pointer; font-size:14px; line-height:1 }
    .remove:hover{ filter:brightness(1.06) }

    .out{ margin-top:16px; border-radius:14px; padding:14px 12px; background:var(--row); border:1px dashed var(--line); min-height:24px }
    .hint{ color:var(--muted); font-size:12px; margin-top:6px }
    .btn{ margin-top:12px; width:100%; border:none; border-radius:14px; padding:14px 16px; font-size:16px; color:#fff; cursor:pointer; background:var(--btn) }
    .btn:hover{ background:var(--btn-hover) }
    .btn.secondary{ background:#0b0d12; border:1px solid var(--line); color:#fff }

    .hamburger{ display:none; }
    .drawer-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.45); opacity:0; pointer-events:none; transition:.2s opacity; z-index:9998 }
    .drawer{ position:fixed; top:0; left:0; height:100%; width:360px; max-width:92vw; background:#0f1115; border-right:1px solid #1e2430; box-shadow:8px 0 40px rgba(0,0,0,.35); transform:translateX(-100%); transition:.25s transform; z-index:9999; color:#e5e7eb; display:flex; flex-direction:column }
    .drawer.open{ transform:translateX(0) }
    .drawer-backdrop.open{ opacity:1; pointer-events:auto }
    .drawer .hd{ padding:14px; border-bottom:1px solid #1e2430; font-size:16px; font-weight:700 }
    .drawer .bd{ padding:14px; overflow:auto }
    .drawer .grp{ margin-bottom:14px }
    .drawer .row2{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
    .drawer .btn-mini{ padding:10px 12px; border:none; border-radius:10px; cursor:pointer; background:var(--btn); color:#fff; font-weight:700 }
    .preset-list{ border:1px solid #1e2430; border-radius:12px; overflow:hidden }
    .preset-item{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px; border-bottom:1px solid #1e2430 }
    .preset-item:last-child{ border-bottom:none }
    .preset-item button{ border:none; background:#11151d; color:#fff; padding:8px 10px; border-radius:9px; cursor:pointer }
    .drawer .muted{ color:#9aa3b2; font-size:12px }

    #versionLabel{ margin-top:12px; margin-bottom:10px; text-align:center; font-size:13px; color:#b7c0cf }
    .logoPreview{ width:100%; max-width:260px; display:block; margin:6px 0 8px; border-radius:12px; background:#11151d; padding:8px }

    @media (orientation: landscape) { .drawer { width: 100vw; max-width: 100vw; } }

    .sheet-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.45); opacity:0; pointer-events:none; transition:.2s opacity; z-index:9998; }
    .sheet{ position:fixed; left:0; right:0; bottom:0; transform:translateY(100%); background:#0f1115; border-top-left-radius:16px; border-top-right-radius:16px; border:1px solid #1e2430; box-shadow:0 -10px 30px rgba(0,0,0,.4); padding:16px; z-index:9999; transition:.25s transform; color:#fff; }
    .sheet.open{ transform:translateY(0) } .sheet-backdrop.open{ opacity:1; pointer-events:auto }
    .sheet h3{ margin:0 0 6px; font-size:18px } .sheet p{ margin:0 0 12px; color:#b7c0cf; font-size:13px }
    .sheet .row2{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
    .sheet .row3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px }
    .btn-mini{ padding:12px 14px; border:none; border-radius:12px; cursor:pointer; background:var(--btn); color:#fff; font-weight:700 }
    .btn-mini.secondary{ background:#0b0d12; border:1px solid var(--line) }

    #toast { position: fixed; left: 50%; bottom: 24px; transform: translateX(-50%); background: #11151d; color: #fff; border: 1px solid #2a2f3c; border-radius: 12px; padding: 10px 14px; font-size: 14px; box-shadow: 0 8px 24px rgba(0,0,0,.35); opacity: 0; pointer-events: none; transition: opacity .2s, transform .2s; z-index: 10000; }
    #toast.show { opacity: 1; transform: translateX(-50%) translateY(-6px); }
  </style>
</head>
<body>
  <div class="wrap">
    <img class="logo" id="companyLogo" src="/Priskalkylator/Icon-512.png" alt="Logotyp" />
    <h1>Offert p√• spr√•ng</h1>

    <button class="btn" id="openDrawer" type="button">Fyll i dina f√∂retagsuppgifter h√§r.</button>

    <!-- Kund -->
    <div class="row" style="margin-top:10px">
      <h2 style="color:#fff;margin:0 0 8px">Fyll i kunduppgifter nedan</h2>

      <div class="grid2">
        <div>
          <label for="kundnamn">Kundnamn</label>
          <input id="kundnamn" type="text" list="customerOptions" placeholder="B√∂rja skriva namn..." />
          <datalist id="customerOptions"></datalist>
        </div>
        <div>
          <label for="telefon">Telefon</label>
          <input id="telefon" type="tel" placeholder="t.ex. 0701-234567" />
        </div>
      </div>

      <div class="grid2">
        <div>
          <label for="kundemail">E-post</label>
          <input id="kundemail" type="email" placeholder="t.ex. exempel@gmail.com" />
        </div>
        <div>
          <label for="kundadress">Adress</label>
          <input id="kundadress" type="text" placeholder="Gatuadress, postnr & ort" />
        </div>
      </div>

      <div class="grid2">
        <div>
          <label for="moms">V√§lj moms</label>
          <select id="moms">
            <option value="0">Exkl. moms</option>
            <option value="0.25" selected>Inkl. 25%</option>
          </select>
        </div>
      </div>

      <!-- Kund: extra uppgifter -->
      <div class="grid2">
        <div>
          <label for="kundYourRef">Er referens</label>
          <input id="kundYourRef" type="text" placeholder="kundens referens" />
        </div>
        <div>
          <label for="kundDelivery">Leveransvillkor</label>
          <input id="kundDelivery" type="text" placeholder="t.ex. Fritt v√•rt lager" />
        </div>
      </div>
    </div>

    <!-- M√•tt + Styck + Tid -->
    <div class="row">
      <h2>L√§gg till m√•tt</h2>
      <div class="grid2">
        <div>
          <label for="artikel">Artikel/Ben√§mning (styr pris via presets)</label>
          <input id="artikel" type="text" list="artikelOptions" placeholder="t.ex. vinylmatta" />
          <datalist id="artikelOptions"></datalist>
        </div>
        <div>
          <label for="pris">Pris per m¬≤ (kr)</label>
          <input id="pris" type="number" min="0" step="1" placeholder="t.ex. 690" />
        </div>
      </div>
      <div class="grid3">
        <div><label for="hojd">H√∂jd (mm)</label><input id="hojd" type="number" min="1" placeholder="t.ex.1000" /></div>
        <div><label for="bredd">Bredd (mm)</label><input id="bredd" type="number" min="1" placeholder="t.ex. 2000" /></div>
        <div><label for="antal">Antal (st)</label><input id="antal" type="number" value="1" min="1" step="1" /></div>
      </div>
      <div id="measurePreview" class="hint">Skriv m√•tt s√• visas radens pris h√§r‚Ä¶</div>
      <button class="btn" id="addMeasure" type="button">Ber√§kna & l√§gg till m√•tt</button>
      <div class="hint">Tips: skriv namnet p√• en sparad preset i <b>Artikel</b> s√• fylls pris och moms automatiskt.</div>

      <h2>L√§gg till stycksaker</h2>
      <div class="grid3">
        <div><label for="itemName">Ben√§mning</label><input id="itemName" type="text" list="itemOptions" placeholder="t.ex. Skruvar" /></div>
        <div><label for="itemPrice">Pris/st (kr)</label><input id="itemPrice" type="number" min="0" step="1" placeholder="t.ex. 59" /></div>
        <div><label for="itemQty">Antal</label><input id="itemQty" type="number" min="1" step="1" value="1" /></div>
      </div>
      <div id="itemPreview" class="hint"></div>
      <button class="btn" id="addItemBtn" type="button">Ber√§kna & l√§gg till stycksak</button>

      <div class="grid3" style="margin-top:12px">
        <div><label for="hourRate">Timpenning (kr/h)</label><input id="hourRate" type="number" min="0" step="1" placeholder="t.ex. 650" /></div>
        <div><label for="hoursQty">Antal timmar</label><input id="hoursQty" type="number" min="0" step="0.25" placeholder="t.ex. 1.5" /></div>
        <div style="display:grid;align-items:end">
          <button class="btn" id="addTimeBtn" type="button">Ber√§kna & l√§gg till timpenning</button>
        </div>
      </div>
      <div id="timePreview" class="hint"></div>

      <div class="compact-list" id="itemsBox" style="margin-top:12px; display:none">
        <table>
          <thead><tr><th>Ben√§mning</th><th>Antal</th><th>Summa</th><th class="act">√Ötg√§rd</th></tr></thead>
          <tbody id="itemsList"></tbody>
        </table>
      </div>
      <datalist id="itemOptions"></datalist>
    </div>

    <!-- Resultat -->
    <label style="margin-top:14px">Ber√§knat pris (alla poster)</label>
    <div id="result" class="out">L√§gg till ett m√•tt eller en post.</div>
    <div id="details" class="hint"></div>

    <!-- √ñvriga uppgifter -->
    <label for="otherInfo" style="margin-top:12px">√ñvriga uppgifter</label>
    <textarea id="otherInfo" placeholder="H√§r kan du skriva i √∂vriga uppgifter. Dessa hamnar alltid under specifikationer i offerten (pdf)"></textarea>

    <!-- Kommentar -->
    <label for="offerNote" style="margin-top:12px">Kommentar</label>
    <textarea id="offerNote" placeholder="Skriv din kommentar h√§r, den l√§ggs till i offerten (Pdf)"></textarea>

    <button class="btn secondary" id="pdf" type="button">Skapa offert (PDF)</button>
    <button class="btn" id="share" type="button">Dela priset</button>

    <!-- üî• PREMIUM-sektion: dynamiskt pris fr√•n Play -->
    <div class="row" style="margin-top:12px">
      <h2>Premium</h2>
      <p id="subStatus" class="hint">Kontrollerar prenumeration‚Ä¶</p>
      <button class="btn" id="buyBtn" type="button" onclick="startSubscription()" disabled>Laddar pris‚Ä¶</button>
      <p id="priceNote" class="hint"></p>
    </div>

    <div id="versionLabel">V4.Benjii</div>
  </div>

  <!-- Drawer -->
  <div class="drawer-backdrop" id="drawerBackdrop" aria-hidden="true"></div>
  <aside class="drawer" id="drawer" aria-label="F√∂rinst√§llningar" aria-hidden="true">
    <div class="hd">F√∂rinst√§llningar</div>
    <div class="bd">
      <div class="grp"><a class="btn-mini" href="/Priskalkylator/">√Öter till kalkylator</a></div>

      <div class="grp">
        <div style="margin-bottom:8px"><b>Avs√§ndare ‚Äì uppgifter som alltid syns i PDF</b></div>
        <div class="row2" style="margin-bottom:8px">
          <div><label>F√∂retagsnamn</label><input id="senderCompany" type="text" placeholder="Ditt f√∂retag" /></div>
          <div><label>Telefon</label><input id="senderPhone" type="tel" placeholder="070-..." /></div>
        </div>
        <div class="row2" style="margin-bottom:8px">
          <div><label>E-post</label><input id="senderEmail" type="email" placeholder="du@foretag.se" /></div>
          <div><label>Adress</label><input id="senderAddress" type="text" placeholder="Gatuadress, postnr ort" /></div>
        </div>

        <!-- Avs√§ndare: extra f√§lt -->
        <div class="row2" style="margin-bottom:8px">
          <div><label>V√•r referens</label><input id="senderOurRef" type="text" placeholder="namn/initialer" /></div>
          <div><label>Betalningsvillkor</label><input id="senderTerms" type="text" placeholder="t.ex. 30 dagar netto" /></div>
        </div>
        <div class="row2" style="margin-bottom:8px">
          <div><label>Dr√∂jsm√•lsr√§nta</label><input id="senderInterest" type="text" placeholder="t.ex. 8% + ref.r√§nta" /></div>
        </div>

        <div style="margin-bottom:8px"><b>PDF-logga (visas endast i PDF)</b></div>
        <input id="logoFile" type="file" accept="image/*" />
        <img id="logoPreview" class="logoPreview" alt="F√∂rhandsvisning" style="display:none" />
        <div class="row2" style="margin-top:8px">
          <button class="btn-mini" id="logoClear" type="button">Ta bort logga</button>
          <button class="btn-mini" id="senderSave" type="button">Spara uppgifter</button>
        </div>
        <span class="muted">Uppgifterna sparas lokalt (denna enhet).</span>
      </div>

      <!-- Kundpresets -->
      <div class="grp">
        <div style="margin-bottom:8px"><b>Spara kund som preset</b></div>
        <div class="row2" style="margin-bottom:8px">
          <div><label>Kundnamn</label><input id="custName" type="text" placeholder="Kund AB" /></div>
          <div><label>Telefon</label><input id="custPhone" type="tel" placeholder="070-..." /></div>
        </div>
        <div class="row2" style="margin-bottom:8px">
          <div><label>E-post</label><input id="custEmail" type="email" placeholder="kund@exempel.se" /></div>
          <div><label>Adress</label><input id="custAddress" type="text" placeholder="Gatuadress, postnr ort" /></div>
        </div>

        <!-- Kundpreset: extra f√§lt -->
        <div class="row2" style="margin-bottom:8px">
          <div><label>Er referens</label><input id="custYourRef" type="text" placeholder="kundens referens" /></div>
          <div><label>Leveransvillkor</label><input id="custDelivery" type="text" placeholder="t.ex. Fritt v√•rt lager" /></div>
        </div>

        <div class="row2" style="margin-top:8px">
          <button class="btn-mini" id="customerSave" type="button">Spara kundpreset</button>
        </div>
      </div>

      <div class="grp">
        <div style="margin-bottom:8px"><b>Sparade kunder</b></div>
        <div class="preset-list" id="customerList"></div>
      </div>

      <!-- m¬≤-presets -->
      <div class="grp">
        <div style="margin-bottom:8px"><b>Skapa egna m¬≤-presets</b></div>
        <label>F√∂rinst√§lld text (titel)</label>
        <input id="presetTitle" type="text" placeholder="t.ex. Vinylmatta" />
        <div class="row2" style="margin-top:8px">
          <div><label>Pris/m¬≤ (kr)</label><input id="presetPrice" type="number" min="0" step="1" /></div>
        </div>
        <label style="margin-top:8px"><input id="presetVat" type="checkbox" checked /> Inkludera 25% moms</label>
        <div class="row2" style="margin-top:10px">
          <button class="btn-mini" id="presetSave" type="button">Spara preset</button>
        </div>
      </div>
      <div class="grp">
        <div style="margin-bottom:8px"><b>Sparade m¬≤-presets</b></div>
        <div class="preset-list" id="presetList"></div>
      </div>

      <!-- Styck-presets -->
      <div class="grp">
        <div style="margin-bottom:8px"><b>Skapa styck-presets</b></div>
        <div class="row2" style="margin-bottom:8px">
          <div><label>Ben√§mning</label><input id="tplName" type="text" placeholder="t.ex. Skrapa" /></div>
          <div><label>Pris/st (kr)</label><input id="tplPrice" type="number" min="0" step="1" placeholder="0" /></div>
        </div>
        <div class="row2" style="margin-top:8px">
          <button class="btn-mini" id="tplSave" type="button">Spara styck-preset</button>
        </div>
      </div>
      <div class="grp">
        <div style="margin-bottom:8px"><b>Sparade styck-presets</b></div>
        <div class="preset-list" id="tplList"></div>
      </div>

      <div class="grp" style="margin-top:20px">
        <a class="btn-mini" href="/Priskalkylator/">√Öter till kalkylator</a>
      </div>
    </div>
  </aside>

  <!-- PDF-sheet -->
  <div id="pdfSheetBackdrop" class="sheet-backdrop" aria-hidden="true"></div>
  <div id="pdfSheet" class="sheet" aria-live="polite" aria-hidden="true">
    <h3>Offert skapad</h3>
    <p id="pdfName">PDF klar.</p>
    <div class="row3" style="margin-top:8px">
      <button id="openPdfBtn" class="btn-mini">√ñppna PDF</button>
      <button id="downloadPdfBtn" class="btn-mini">Ladda ner</button>
      <button id="sharePdfBtn" class="btn-mini secondary">Dela</button>
    </div>
    <div class="row2" style="margin-top:10px">
      <button id="closeSheetBtn" class="btn-mini secondary">St√§ng</button>
    </div>
  </div>

  <div id="toast" role="status" aria-live="polite" aria-atomic="true"></div>

  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    "use strict";
    const $ = id => document.getElementById(id);
    const on = (id, ev, fn) => { const el = $(id); if (el) el.addEventListener(ev, fn); };

    function toast(msg, ms = 1800){
      const el = $('toast');
      if (!el) return;
      el.textContent = String(msg ?? '');
      el.classList.add('show');
      clearTimeout(el._t);
      el._t = setTimeout(()=> el.classList.remove('show'), ms);
    }
    window.alert = toast;

    const LS_PRESETS="rg_presets_v1", LS_ITEMS="rg_items_v1", LS_TPLS="rg_item_templates_v1",
          LS_LOGO="rg_company_logo_dataurl", LS_SENDER="rg_sender_profile_v1",
          LS_CUSTOMERS="rg_customers_v1", LS_OFFER_NO="rg_offer_no_v1";

    let items=loadJSON(LS_ITEMS,[]), presets=loadJSON(LS_PRESETS,[]),
        customers=loadJSON(LS_CUSTOMERS,[]), itemTemplates=loadJSON(LS_TPLS,[]),
        logoDataURL=localStorage.getItem(LS_LOGO)||"";

    let lastPdfBlob = null, lastPdfUrl = null, lastPdfFilename = "offert.pdf";

    function loadJSON(k,f){ try{ return JSON.parse(localStorage.getItem(k)||JSON.stringify(f)); }catch{ return f; } }
    function saveJSON(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
    function setLogoPreview(){ const el=$("logoPreview"); if(logoDataURL){ el.src=logoDataURL; el.style.display="block"; } else { el.style.display="none"; } }

    const fmt0=n=>Number(n||0).toLocaleString("sv-SE",{maximumFractionDigits:0});
    const fmt2=n=>Number(n||0).toLocaleString("sv-SE",{minimumFractionDigits:2,maximumFractionDigits:2});

    function previewMeasureLine(){
      const h=parseFloat($("hojd").value), b=parseFloat($("bredd").value), qty=parseFloat($("antal").value||"1");
      const price=parseFloat($("pris").value), moms=parseFloat($("moms").value||"0"), box=$("measurePreview");
      if(!h||!b||!price||!qty){ box.textContent="Skriv m√•tt s√• visas radens pris h√§r‚Ä¶"; return; }
      const area=(h/1000)*(b/1000), exkl=area*price*qty, inkl=exkl*(1+moms);
      box.textContent=`Rad: ${fmt2(area)} m¬≤/st √ó ${price} kr/m¬≤ √ó ${qty} st = ${fmt0(exkl)} kr exkl ‚Ä¢ ${fmt0(inkl)} kr inkl moms`;
    }
    function previewItemLine(){
      const price=parseFloat($("itemPrice").value), qty=parseFloat($("itemQty").value||"1"), moms=parseFloat($("moms").value||"0"), box=$("itemPreview");
      if(!price||!qty){ box.textContent=""; return; }
      const exkl=price*qty, inkl=exkl*(1+moms); box.textContent=`Rad: ${fmt0(exkl)} kr exkl ‚Ä¢ ${fmt0(inkl)} kr inkl moms`;
    }
    function previewTimeLine(){
      const rate=parseFloat($("hourRate").value), hours=parseFloat($("hoursQty").value), moms=parseFloat($("moms").value||"0"), box=$("timePreview");
      if(!rate||!hours){ box.textContent=""; return; }
      const exkl=rate*hours, inkl=exkl*(1+moms); box.textContent=`Rad: ${fmt0(exkl)} kr exkl ‚Ä¢ ${fmt0(inkl)} kr inkl moms`;
    }

    function render(){
      const list=$("itemsList"); list.innerHTML=""; let total=0;
      items.forEach((it,i)=>{
        const rowTotal=Number(it.price||0)*Number(it.qty||0); total+=rowTotal;
        const tr=document.createElement("tr");
        tr.innerHTML=`<td style="white-space:normal">${it.name}</td>
                      <td>${it.qty}</td>
                      <td>${fmt0(rowTotal)} kr</td>
                      <td class="act"><button class="remove" data-item="${i}" aria-label="Ta bort post">√ó</button></td>`;
        list.appendChild(tr);
      });
      $("itemsBox").style.display=items.length?"block":"none";
      const moms=parseFloat($("moms").value||"0"), sumExkl=total, sumMoms=sumExkl*moms, sumInkl=sumExkl+sumMoms;
      $("result").textContent=`${fmt0(sumInkl)} kr`; $("details").textContent=`${fmt0(sumExkl)} kr ‚Ä¢ Moms: ${fmt0(sumMoms)} kr`;
      saveJSON(LS_ITEMS, items);
    }

    function refreshArtikelDatalist(){ const dl=$("artikelOptions"); dl.innerHTML=""; presets.forEach(p=>{ const o=document.createElement("option"); o.value=p.artikel; dl.appendChild(o); }); }
    function refreshCustomerDatalist(){ const dl=$("customerOptions"); dl.innerHTML=""; customers.forEach(c=>{ const o=document.createElement("option"); o.value=c.name; dl.appendChild(o); }); }
    function refreshItemDatalist(){ const dl=$("itemOptions"); dl.innerHTML=""; itemTemplates.forEach(t=>{ const o=document.createElement("option"); o.value=t.name; dl.appendChild(o); }); }

    // Fyll f√§lt vid val av kund
    $("kundnamn").addEventListener("change", ()=>{
      const name=$("kundnamn").value.trim();
      const c=customers.find(x=>x.name.toLowerCase()===name.toLowerCase());
      if(c){
        $("telefon").value      = c.phone   || "";
        $("kundemail").value    = c.email   || "";
        $("kundadress").value   = c.address || "";
        $("kundYourRef").value  = c.yourRef || "";
        $("kundDelivery").value = c.delivery|| "";
      }
    });

    $("artikel").addEventListener("change", ()=>{ const name=$("artikel").value.trim(); const p=presets.find(x=>x.artikel.toLowerCase()===name.toLowerCase()); if(p){ $("pris").value=p.pris; $("moms").value=p.moms; previewMeasureLine(); } });
    $("itemName").addEventListener("change", ()=>{ const name=$("itemName").value.trim(); const t=itemTemplates.find(x=>x.name.toLowerCase()===name.toLowerCase()); if(t){ $("itemPrice").value=t.price||""; previewItemLine(); } });

    $("moms").addEventListener("change", ()=>{ previewMeasureLine(); previewItemLine(); previewTimeLine(); render(); });

    $("addMeasure").addEventListener("click", ()=>{
      const artikel=$("artikel").value.trim()||"Artikel";
      const h=parseFloat($("hojd").value), b=parseFloat($("bredd").value), qty=parseInt($("antal").value), price=parseFloat($("pris").value);
      if(!h||!b||!qty||!price) return;
      const area=(h/1000)*(b/1000); const unitPrice=area*price;
      const name=`${artikel} ‚Äî ${h}√ó${b} mm ‚Ä¢ ${fmt2(area)} m¬≤/st ‚Ä¢ √° ${fmt2(price)} kr/m¬≤`;
      items.push({ name, price:unitPrice, qty }); render(); previewMeasureLine();
    });

    document.addEventListener("click", (e)=>{
      const t=e.target; if(!(t instanceof HTMLElement)) return;
      const idx=t.getAttribute("data-item"); if(idx!=null){ items.splice(Number(idx),1); render(); }
    });

    $("addItemBtn").addEventListener("click", ()=>{
      const name=$("itemName").value.trim(), price=parseFloat($("itemPrice").value), qty=parseInt($("itemQty").value);
      if(!name||!price||!qty) return;
      items.push({ name, price, qty }); $("itemName").value=""; $("itemPrice").value=""; $("itemQty").value="1";
      render(); previewItemLine();
    });
    $("addTimeBtn").addEventListener("click", ()=>{
      const rate=parseFloat($("hourRate").value), hours=parseFloat($("hoursQty").value); if(!rate||!hours) return;
      items.push({ name:"Arbetstid", price:rate, qty:hours }); $("hourRate").value=""; $("hoursQty").value=""; render(); previewTimeLine();
    });

    ["hojd","bredd","antal","pris","artikel"].forEach(id=>{ $(id).addEventListener("input", previewMeasureLine); $(id).addEventListener("change", previewMeasureLine); });
    ["itemPrice","itemQty"].forEach(id=>{ $(id).addEventListener("input", previewItemLine); $(id).addEventListener("change", previewItemLine); });
    ["hourRate","hoursQty"].forEach(id=>{ $(id).addEventListener("input", previewTimeLine); $(id).addEventListener("change", previewTimeLine); });

    $("share").addEventListener("click", ()=>{
      const text=`${$("result").textContent} (${$("details").textContent})`;
      if(navigator.share){ navigator.share({ title:"Offert", text }).catch(()=>{}); }
      else { navigator.clipboard?.writeText(text).then(()=>alert("Belopp kopierat!")).catch(()=>alert(text)); }
    });

    // ====== PDF ====== (of√∂r√§ndrat ‚Äì din befintliga kod)
    // ... (hela din PDF-kod h√§r, of√∂r√§ndrad ‚Äì l√§mnad intakt)

  </script>

  <!-- Gate -->
  <style>
    #appGate{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.98); z-index:99999; color:#fff; text-align:center; padding:24px; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
    #appGate .box{ max-width:560px; width:min(92vw,560px); background:#11151d; border:1px solid #2a2f3c; border-radius:16px; padding:22px; box-shadow:0 12px 30px rgba(0,0,0,.35) }
    #appGate h3{ margin:0 0 8px; font-size:20px } #appGate p{ margin:6px 0 0; color:#b7c0cf; font-size:14px }
  </style>
  <div id="appGate" aria-live="assertive" aria-hidden="true">
    <div class="box">
      <h3>√Ötkomst nekad</h3>
      <p>Den h√§r tj√§nsten kan bara anv√§ndas i <b>Offert p√• spr√•ng</b>-appen.</p>
    </div>
  </div>
  <script>
    (function () {
      var isFromTWA = document.referrer && document.referrer.indexOf('android-app://se.reklamgiganten.priskalkylator') === 0;
      if (isFromTWA) { try { sessionStorage.setItem('twa_ok', '1'); } catch(e) {} }
      var allowed = isFromTWA || (function(){ try { return sessionStorage.getItem('twa_ok') === '1'; } catch(e) { return false; } })();
      if (!allowed) {
        var app = document.querySelector('.wrap'); if (app) app.style.display = 'none';
        var gate = document.getElementById('appGate'); if (gate) gate.style.display = 'grid';
        document.body.style.overflow = 'hidden';
      }
    })();
  </script>

  <!-- PWA -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/Priskalkylator/sw.js', { scope: '/Priskalkylator/' }).then(reg => {
        if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });
        reg.addEventListener('updatefound', () => {
          const sw = reg.installing; if (!sw) return;
          sw.addEventListener('statechange', () => {
            if (sw.state === 'installed' && reg.waiting) {
              reg.waiting.postMessage({ type: 'SKIP_WAITING' });
            }
          });
        });
      }).catch(console.error);
    }
  </script>

  <!-- üîó L√§nka in billing.js (m√•ste ligga efter allt ovan) -->
  <script src="/Priskalkylator/billing.js"></script>

  <!-- üîß Init f√∂r premium: h√§mtar pris & kollar aktiv pren -->
  <script>
    (async function(){
      const SKU = 'manad75';
      const btn = document.getElementById('buyBtn');
      const statusEl = document.getElementById('subStatus');
      const noteEl = document.getElementById('priceNote');

      try {
        // F√∂rs√∂k l√§sa pris fr√•n Play (Digital Goods API fungerar i TWA/Play-installation)
        const dgs = await (window.getDigitalGoodsService && window.getDigitalGoodsService('https://play.google.com/billing'));
        if (dgs) {
          const [detail] = await dgs.getDetails([SKU]);
          if (detail && detail.price) {
            btn.textContent = `K√∂p Premium (${detail.price}/m√•n)`;
          } else {
            btn.textContent = 'K√∂p Premium (79 kr/m√•n)';
          }
        } else {
          btn.textContent = 'K√∂p Premium (79 kr/m√•n)';
          noteEl.textContent = 'Tips: Installera via Google Play-appen f√∂r att kunna k√∂pa prenumerationen.';
        }
        btn.disabled = false;

        // Kolla om prenumeration redan finns
        const hasSub = await (window.checkSubscription ? window.checkSubscription() : Promise.resolve(false));
        if (hasSub) {
          statusEl.textContent = '‚úÖ Aktiv prenumeration';
          btn.style.display = 'none';
        } else {
          statusEl.textContent = '‚ùå Ingen prenumeration';
          btn.style.display = 'inline-block';
        }
      } catch (err) {
        console.error(err);
        btn.textContent = 'K√∂p Premium (79 kr/m√•n)';
        btn.disabled = false;
        statusEl.textContent = 'Kan inte kontrollera prenumeration just nu.';
      }
    })();
  </script>
</body>
</html>
